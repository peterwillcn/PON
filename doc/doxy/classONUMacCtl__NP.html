<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>EPONImplementationforOMNet++: ONUMacCtl_NP Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">EPONImplementationforOMNet++
   &#160;<span id="projectnumber">0.8Beta</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('classONUMacCtl__NP.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="#pro-attribs">Protected Attributes</a> &#124;
<a href="#pri-methods">Private Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">ONUMacCtl_NP Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ONUMacCtl_NP" --><!-- doxytag: inherits="ONUMacCtlBase" -->
<p>ONUMacCtl class controls the below MAC layer transmission times.  
 <a href="classONUMacCtl__NP.html#details">More...</a></p>

<p><code>#include &lt;ONUMacCtl_NP.h&gt;</code></p>
<div class="dynheader">
Inheritance diagram for ONUMacCtl_NP:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classONUMacCtl__NP.png" usemap="#ONUMacCtl_NP_map" alt=""/>
  <map id="ONUMacCtl_NP_map" name="ONUMacCtl_NP_map">
<area href="classONUMacCtlBase.html" alt="ONUMacCtlBase" shape="rect" coords="0,0,107,24"/>
</map>
 </div></div>

<p><a href="classONUMacCtl__NP-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#ab4307e9f55fedeebb224e8801123768a">ONUMacCtl_NP</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#ab95ec87a291a13f65c281b6e191d5adf">~ONUMacCtl_NP</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a5ffa6f0515adad31af660b696ae64405">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a33f5cf946eec7c7aa9be64132cb3914d">handleMessage</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a121eedab5b48dca24530cfebbca9288d">processFrameFromHigherLayer</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a8a2971241fdf070c7a4eb42f355a716f">processMPCP</a> (EthernetIIFrame *frame)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a8d0254da56917bcd88bc7de62c46d488">scheduleStopTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30">startTxOnPON</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Directly called for start Messages and called if a frame arrives in IDLE.  <a href="#a5731bf5d90c2876f256c6494d84c4a30"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#ab62365f4dc4787fd7ce7f8d61582bb47">handleStopTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#adac2d1a3537f6cbd944a900b0cfc141f">clockSync</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Update the clock.  <a href="#adac2d1a3537f6cbd944a900b0cfc141f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5">shiftStart1Slot</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">This method shifts the start register for one SuperSlot.  <a href="#a7fcacd095b1100ac337bb8e35798a7a5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a21d21569c768c65f20dddae0b305603d">shiftStartXSlots</a> (uint32_t X)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">This method handles the start register when the module wakes up from SLEEP state and it has lost many SuperSlots.  <a href="#a21d21569c768c65f20dddae0b305603d"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pro-attribs"></a>
Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a></td></tr>
<tr><td colspan="2"><h2><a name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#ad16ac12e6930cc78d43894ba035efc0f">goToIDLE</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__NP.html#a8273e0ab2ee4a31cebd902ef91f0d52a">goToSLEEP</a> ()</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>ONUMacCtl class controls the below MAC layer transmission times. </p>
<p>This version is fairly more complicated from the OLT one because we have transmit in specific times. The module can come to IDLE or SLEEP states which means that the clock and the start register are left back. (The clock is updated on each message reception).</p>
<p>Also this class has a pointer to the EPON_Q_mgmt module and it uses it as a simple queue in order to get frames. Finally note that missing mac addresses and LLIDs (from frames) are filled in here, cause the lower layer expects them. </p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="ab4307e9f55fedeebb224e8801123768a"></a><!-- doxytag: member="ONUMacCtl_NP::ONUMacCtl_NP" ref="ab4307e9f55fedeebb224e8801123768a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classONUMacCtl__NP.html#ab4307e9f55fedeebb224e8801123768a">ONUMacCtl_NP::ONUMacCtl_NP</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                          {
      <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>=0;
      <a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>=0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab95ec87a291a13f65c281b6e191d5adf"></a><!-- doxytag: member="ONUMacCtl_NP::~ONUMacCtl_NP" ref="ab95ec87a291a13f65c281b6e191d5adf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classONUMacCtl__NP.html#ab95ec87a291a13f65c281b6e191d5adf">ONUMacCtl_NP::~ONUMacCtl_NP</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                           {

      cancelAndDelete(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      cancelAndDelete(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);

}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="adac2d1a3537f6cbd944a900b0cfc141f"></a><!-- doxytag: member="ONUMacCtl_NP::clockSync" ref="adac2d1a3537f6cbd944a900b0cfc141f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#adac2d1a3537f6cbd944a900b0cfc141f">ONUMacCtl_NP::clockSync</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update the clock. </p>
<p>Note that the clock can be reseted back to 0 (zero) cause it is define by <a class="el" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> as 32bit register (of 16 nanoseconds granularity). This is also handled here. </p>
<p>Multi shift</p>
<p>Check Slot Shift... NOTE: skew introduced</p>
<div class="fragment"><pre class="fragment">                            {

      EV &lt;&lt; <span class="stringliteral">&quot;\n\n============= CLOCK: &quot;</span>;
      <span class="comment">// NOTE: Clock is in sync with the simulation clock</span>
      <span class="comment">// a small skew can be added here (random)</span>


      <span class="comment">// Reset start/stop</span>
      uint32_t simT = <a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>();


      <span class="comment">// No clock shift</span>
      <span class="keywordflow">if</span> (simT&gt;=<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>){
            <span class="comment">// Update the clock</span>
            <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> = simT;
            EV &lt;&lt; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &lt;&lt; <span class="stringliteral">&quot;=======================\n&quot;</span>;
            <span class="keywordflow">return</span>;
      }

      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;simT){
            EV &lt;&lt; <span class="stringliteral">&quot;MULTI SHIFT =====================\n&quot;</span> &lt;&lt;endl;
            <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> = simT;
            <span class="comment">// Super Slot ...</span>
            uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a>/16*<a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a>;
            uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> - <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>)/slotTime16ns);
            <a class="code" href="classONUMacCtl__NP.html#a21d21569c768c65f20dddae0b305603d" title="This method handles the start register when the module wakes up from SLEEP state and it has lost many...">shiftStartXSlots</a>(lostSlots);
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Single shift (1 reg loop)</span>

      <span class="comment">// Reschedule the clock</span>
      <span class="comment">// In ANY case start reg is wrong</span>
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
      cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);

      EV &lt;&lt; <span class="stringliteral">&quot; SHIFT =======================\n&quot;</span>;


      <span class="comment">// Update the clock</span>
      <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> = simT;

      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();


      EV &lt;&lt; <span class="stringliteral">&quot;===========================================\n\n\n&quot;</span>;

}
</pre></div>
</div>
</div>
<a class="anchor" id="ad16ac12e6930cc78d43894ba035efc0f"></a><!-- doxytag: member="ONUMacCtl_NP::goToIDLE" ref="ad16ac12e6930cc78d43894ba035efc0f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#ad16ac12e6930cc78d43894ba035efc0f">ONUMacCtl_NP::goToIDLE</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                           {
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="OLTMacCtl__NP_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>;
      cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
      cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      <a class="code" href="classONUMacCtl__NP.html#a8d0254da56917bcd88bc7de62c46d488">scheduleStopTxPeriod</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8273e0ab2ee4a31cebd902ef91f0d52a"></a><!-- doxytag: member="ONUMacCtl_NP::goToSLEEP" ref="a8273e0ab2ee4a31cebd902ef91f0d52a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a8273e0ab2ee4a31cebd902ef91f0d52a">ONUMacCtl_NP::goToSLEEP</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                            {
      EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM ?? TO _SLEEP_\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#a824358e42beb5218bdbf3c56f314c119">queue_mod</a>-&gt;requestPacket();
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#aa22f344687606a775a3466beffd86e77" title="It may or may not be our turn BUT ALL Qs ARE EMPTY (no need to schedule startTx)">TX_SLEEP</a>;
      <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a33f5cf946eec7c7aa9be64132cb3914d"></a><!-- doxytag: member="ONUMacCtl_NP::handleMessage" ref="a33f5cf946eec7c7aa9be64132cb3914d" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a33f5cf946eec7c7aa9be64132cb3914d">ONUMacCtl_NP::handleMessage</a> </td>
          <td>(</td>
          <td class="paramtype">cMessage *&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{

      <span class="comment">// Update clock from simTime</span>
      <span class="comment">// The clock MUST be in sync</span>
      <span class="comment">// when stop is scheduled. Stop</span>
      <span class="comment">// is called only when entering IDLE</span>
      <a class="code" href="classONUMacCtl__NP.html#adac2d1a3537f6cbd944a900b0cfc141f" title="Update the clock.">clockSync</a>();

      <span class="comment">// Self Message</span>
      <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
      {
            EV &lt;&lt; <span class="stringliteral">&quot;Self-message &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; received\n&quot;</span>;

            <span class="keywordflow">if</span> (msg == <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>){
                  <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> == <a class="code" href="OLTMacCtl__NP_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>) {std::cout&lt;&lt;*msg&lt;&lt;endl; <span class="keyword">delete</span> msg; error(<span class="stringliteral">&quot;?&quot;</span>); }
                  <a class="code" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg == <a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>)
                  <a class="code" href="classONUMacCtl__NP.html#ab62365f4dc4787fd7ce7f8d61582bb47">handleStopTxPeriod</a>();
            <span class="keywordflow">else</span>
                  error(<span class="stringliteral">&quot;Unknown self message received!&quot;</span>);


            <span class="keywordflow">return</span>;
      }



      <span class="comment">// Network Message</span>
      cGate *ingate = msg-&gt;getArrivalGate();
      EV &lt;&lt; <span class="stringliteral">&quot;Frame &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived on port &quot;</span> &lt;&lt; ingate-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;...\n&quot;</span>;

      <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;lowerLayerIn&quot;</span>)-&gt;getId()){
            <a class="code" href="classONUMacCtlBase.html#a25c02d7068d5311c39ac0b1faec3f1c6">processFrameFromMAC</a>(msg);
      }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;upperLayerIn&quot;</span>)-&gt;getId()){
            <a class="code" href="classONUMacCtl__NP.html#a121eedab5b48dca24530cfebbca9288d">processFrameFromHigherLayer</a>(msg);
      }<span class="keywordflow">else</span>{
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Message came FROM THE WRONG DIRRECTION???? Dropping\n&quot;</span>;
            <span class="keyword">delete</span> msg;
      }

}
</pre></div>
</div>
</div>
<a class="anchor" id="ab62365f4dc4787fd7ce7f8d61582bb47"></a><!-- doxytag: member="ONUMacCtl_NP::handleStopTxPeriod" ref="ab62365f4dc4787fd7ce7f8d61582bb47" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#ab62365f4dc4787fd7ce7f8d61582bb47">ONUMacCtl_NP::handleStopTxPeriod</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                     {

      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
      EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM ?? TO _OFF_\n&quot;</span>;

      <span class="comment">/*</span>
<span class="comment">       *  Do NOT call start all the time...</span>
<span class="comment">       *</span>
<span class="comment">       *  WE TRIED... :-)</span>
<span class="comment">       */</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.isEmpty()){
            <a class="code" href="classONUMacCtl__NP.html#a8273e0ab2ee4a31cebd902ef91f0d52a">goToSLEEP</a>();
            <span class="comment">// DO NOT RESCHEDULE START...</span>
            <span class="keywordflow">return</span>;
      }


      <span class="comment">// Shift the start_reg</span>
      <a class="code" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5ffa6f0515adad31af660b696ae64405"></a><!-- doxytag: member="ONUMacCtl_NP::initialize" ref="a5ffa6f0515adad31af660b696ae64405" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a5ffa6f0515adad31af660b696ae64405">ONUMacCtl_NP::initialize</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="classONUMacCtlBase.html#a0137cf8a14df90d754186fd668e45524">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">{
      <span class="comment">// Do the common stuff...</span>
      <a class="code" href="classONUMacCtl__NP.html#a5ffa6f0515adad31af660b696ae64405">ONUMacCtlBase::initialize</a>();

      <a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;stopTxMsg&quot;</span>, <a class="code" href="ONUMacCtl__NP_8h.html#a802a25fb2e007ec326e21f3ac6b0600a">STOPTXMSG</a>);

}
</pre></div>
</div>
</div>
<a class="anchor" id="a121eedab5b48dca24530cfebbca9288d"></a><!-- doxytag: member="ONUMacCtl_NP::processFrameFromHigherLayer" ref="a121eedab5b48dca24530cfebbca9288d" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a121eedab5b48dca24530cfebbca9288d">ONUMacCtl_NP::processFrameFromHigherLayer</a> </td>
          <td>(</td>
          <td class="paramtype">cMessage *&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                                           {
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Outgoing message, forwarding...\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#a562396f2fc470faf915fcb171fed0f42">numFramesFromHL</a>++;

      <span class="comment">// Pre-Configuration ... Check and send only MPCP</span>
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Packet &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived from higher layers, sending\n&quot;</span>;
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> == 0 ){
            EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_NP: Frame arrived in pre-conf stage &quot;</span>&lt;&lt;endl;

            <span class="comment">// Send only if it is an MPCP message</span>
            EthernetIIFrame * frame = <span class="keyword">dynamic_cast&lt;</span>EthernetIIFrame *<span class="keyword">&gt;</span>(msg);
            <span class="keywordflow">if</span> (frame &amp;&amp; frame-&gt;getEtherType() == <a class="code" href="MPCP__codes_8h.html#a01d93522186165aff8e9d9907b04aec3">MPCP_TYPE</a>){
                  send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
                  <span class="keywordflow">return</span>;
            }

            EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_NP: DROPPING &quot;</span>&lt;&lt;endl;
            <span class="keyword">delete</span> msg;
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Check for a WAKE UP message</span>
      <span class="keywordflow">if</span> (msg-&gt;getKind() == <a class="code" href="OLTMacCtl__NP_8h.html#a3593b1b91fec6813d3d03abfee96f8e7">WAKEUPMSG</a>){
            EV &lt;&lt; <span class="stringliteral">&quot;Wake UP message received...&quot;</span> &lt;&lt; endl;
            <span class="comment">// Discard it...</span>
            <span class="keyword">delete</span> msg;
      }<span class="keywordflow">else</span>{
            <span class="comment">// ENQUEUE</span>
            EV &lt;&lt; <span class="stringliteral">&quot;Queuing message...&quot;</span> &lt;&lt; endl;
            <a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.insert(msg);
      }


      <span class="comment">// Re-schedule tx period</span>
      <span class="comment">// Check if we are idle, if yes start transmission</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> == <a class="code" href="OLTMacCtl__NP_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>){
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: CHANGING STATE FROM _IDLE_ TO _ON_\n&quot;</span>;
            <span class="comment">// Cancel Previous DeadLine</span>
            cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
            <a class="code" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
      }
      <span class="comment">// Check if we are asleep</span>
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> == <a class="code" href="ONUMacCtlBase_8h.html#aa22f344687606a775a3466beffd86e77" title="It may or may not be our turn BUT ALL Qs ARE EMPTY (no need to schedule startTx)">TX_SLEEP</a>){
            <span class="comment">// IF start_reg is in the future just reschedule startTX</span>
            <span class="comment">// ELSE shift the clock the lost slots...</span>
            <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &lt; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>){
                  cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
                  <a class="code" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a>();
            }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &gt;= <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &lt; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> + <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>){
                  cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
                  <a class="code" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
            }<span class="keywordflow">else</span> {
                  <span class="comment">// Super Slot ...</span>
                  uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a>/16*<a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a>;
                  uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> - <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>)/slotTime16ns);
                  <a class="code" href="classONUMacCtl__NP.html#a21d21569c768c65f20dddae0b305603d" title="This method handles the start register when the module wakes up from SLEEP state and it has lost many...">shiftStartXSlots</a>(lostSlots);
            }
      }



}
</pre></div>
</div>
</div>
<a class="anchor" id="a8a2971241fdf070c7a4eb42f355a716f"></a><!-- doxytag: member="ONUMacCtl_NP::processMPCP" ref="a8a2971241fdf070c7a4eb42f355a716f" args="(EthernetIIFrame *frame)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a8a2971241fdf070c7a4eb42f355a716f">ONUMacCtl_NP::processMPCP</a> </td>
          <td>(</td>
          <td class="paramtype">EthernetIIFrame *&#160;</td>
          <td class="paramname"><em>frame</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>NOTE: Announced time IS NOT ALWAYS ON THE FUTURE IF we want the announced times to be on the future then the DBA algorithms MUST CONSIDER RTT. For simplicity we do accept to loose some slots...</p>

<p>Implements <a class="el" href="classONUMacCtlBase.html#a73e2d245fd886ba3f53ab59df9feaca3">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">                                                     {
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: MPCP Frame processing\n&quot;</span>;
      <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = check_and_cast&lt;<a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *&gt;(frame);


      <span class="comment">// DONT... DONT EVEN THINK OF IT</span>
<span class="comment">//    EV &lt;&lt; &quot;ONUMacCtl_NP: Updating our clock from: &quot;&lt;&lt;clock_reg&lt;&lt;&quot; to &quot;;</span>
<span class="comment">//    clock_reg=mpcp-&gt;getTs();</span>
<span class="comment">//    EV &lt;&lt; clock_reg &lt;&lt; endl;</span>

      <span class="keywordflow">switch</span> (mpcp-&gt;<a class="code" href="classMPCP.html#a68374d0a62fbdd1c40f264f1a9a9230b">getOpcode</a>())
      {

            <span class="keywordflow">case</span> <a class="code" href="MPCP__codes_8h.html#a190716814784e1e13cfd09ef6e773f5d">MPCP_GATE</a>:
            {
                  <a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> * gate = check_and_cast&lt;<a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> *&gt;(frame);
                  EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Type is MPCP_GATE\n&quot;</span>;

                  <span class="keywordflow">if</span> (gate-&gt;<a class="code" href="classMPCPGate.html#aa568e79e9c26b388d9e291ccd76db8c5">getListLen</a>() == 0) {
                        EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: !!! NO ALLOCATION FOR US :-( (bitches...)&quot;</span>;
                        <span class="keywordflow">break</span>;
                  }


                  <span class="comment">// Update with 1st alloc</span>
                  <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a188d0342a2fb1c02190fc079aa2b20d9">getStartTime</a>(0);
                  <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a3b82c4a4e1246e2170e49451690d9efe">getDuration</a>(0);
                  <a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a568ad27f81f61ff5bb0eb5d1b6aad9b9">getSlotTime</a>();
                  <a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a> = gate-&gt;<a class="code" href="classMPCPGate.html#ab25cbd133a2cf312e62abe9d80aa5d8d">getSlotsNum</a>();


                  <span class="keywordflow">if</span> ( <a class="code" href="classONUMacCtlBase.html#a13bae0a24f63d7823a8a8917ca95512f">numGates</a> == 0){
                        EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: MPCP_GATE arrived, IT IS INITIAL - MAC: &quot;</span>&lt;&lt;frame-&gt;getDest()&lt;&lt;endl;
                        <span class="comment">// Cancel ALL an scheduled TX</span>
                        cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
                        cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
                        <a class="code" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a>();
                  }<span class="keywordflow">else</span>{

                        <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> + <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>){
                              <span class="comment">// Time assigned is in past</span>
                              EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: MPCP_GATE arrived, calculating lost slots&quot;</span>&lt;&lt;endl;

                              <span class="comment">// Super Slot ...</span>
                              uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a>/16*<a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a>;
                              uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> - <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>)/slotTime16ns);
                              <a class="code" href="classONUMacCtl__NP.html#a21d21569c768c65f20dddae0b305603d" title="This method handles the start register when the module wakes up from SLEEP state and it has lost many...">shiftStartXSlots</a>(lostSlots);
                        }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;=<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &lt; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> + <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>){
                              EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: MPCP_GATE arrived, it is our time&quot;</span>&lt;&lt;endl;
                              <span class="comment">// Now is our time</span>
                              <a class="code" href="classONUMacCtl__NP.html#a8d0254da56917bcd88bc7de62c46d488">scheduleStopTxPeriod</a>();
                              <a class="code" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
                        }<span class="keywordflow">else</span>{
                              <span class="comment">// Time assigned is in future</span>
                              EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: MPCP_GATE arrived, no lost slots&quot;</span>&lt;&lt;endl;
                              <a class="code" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a>();
                        }
                  }


                  <a class="code" href="classONUMacCtlBase.html#a13bae0a24f63d7823a8a8917ca95512f">numGates</a>++;
                  <span class="keywordflow">break</span>;
            }
            <span class="keywordflow">default</span>:
                  <span class="keywordflow">break</span>;
      };

}
</pre></div>
</div>
</div>
<a class="anchor" id="a5eeae37afd1ce53b7245a3da0a91069b"></a><!-- doxytag: member="ONUMacCtl_NP::scheduleStartTxPeriod" ref="a5eeae37afd1ce53b7245a3da0a91069b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">ONUMacCtl_NP::scheduleStartTxPeriod</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                        {

      EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM ?? TO _OFF_\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;


      <span class="comment">/*</span>
<span class="comment">       *  start_reg shifted clock_reg did not</span>
<span class="comment">       *  HANDLE AND RETURN.</span>
<span class="comment">       *</span>
<span class="comment">       *  NOTE:   This should occur only on shifted registers.</span>
<span class="comment">       *          MPCP could have the same result but we are fixing</span>
<span class="comment">       *          it by shifting the clock on receive.</span>
<span class="comment">       */</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>!=0 &amp;&amp; (uint64_t)<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>) {
            EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_NP: Start_reg shifted clock_reg did not&quot;</span>&lt;&lt;endl;
            <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();
            <span class="comment">//error(&quot;start_reg+len_reg&lt;clock_reg &quot;);</span>


            simtime_t nextTx;

            nextTx.setRaw(simTime().raw() + <span class="comment">// NOW</span>
                        <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> + <span class="comment">// Remaining (not shifted clock)</span>
                                    <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>
                              ));
            EV&lt;&lt;<span class="stringliteral">&quot;....&quot;</span>&lt;&lt;(<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> +<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>)&lt;&lt;endl;
            EV&lt;&lt;<span class="stringliteral">&quot;scheduleStartTxPeriod: &quot;</span>&lt;&lt;nextTx&lt;&lt;endl;

            cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            scheduleAt(nextTx, <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            <span class="keywordflow">return</span>;
      }

      simtime_t nextTx;
      <span class="comment">// Start the next moment...</span>
      nextTx.setRaw(simTime().raw());

      <span class="comment">// If start time is ahead sim time Start now</span>
      <span class="comment">// clock_reg == MPCPTools::simTimeToNS16()....</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&gt;=<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>){
            nextTx.setRaw(simTime().raw()+                                                <span class="comment">//Now (NOTE: not the clock_reg)</span>
                                <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>) <span class="comment">//Remaining time to Start</span>
                               );
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Start scheduled. Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;<span class="stringliteral">&quot; Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
      }<span class="keywordflow">else</span>{
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Starting NOW. Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;<span class="stringliteral">&quot; Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
      }


      cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      scheduleAt(nextTx, <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8d0254da56917bcd88bc7de62c46d488"></a><!-- doxytag: member="ONUMacCtl_NP::scheduleStopTxPeriod" ref="a8d0254da56917bcd88bc7de62c46d488" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a8d0254da56917bcd88bc7de62c46d488">ONUMacCtl_NP::scheduleStopTxPeriod</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                       {

      <span class="comment">// You cannot calculate next time from registers...</span>
      <span class="comment">// Simulation time may be different (regs are shifted)</span>
      <span class="comment">// So calculate the remaining time...</span>
      simtime_t stopTX;
      stopTX.setRaw( simTime().raw() +                                   <span class="comment">// Now</span>
                  <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> +<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>) <span class="comment">// Remaining</span>
      );
      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();
      EV &lt;&lt; <span class="stringliteral">&quot;Scheduled after (ns16): &quot;</span> &lt;&lt; (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> +<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>) &lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;Scheduled after  (raw): &quot;</span> &lt;&lt; <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> +<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>) &lt;&lt;endl;

      <span class="comment">// Just in case..</span>
      cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
      scheduleAt(stopTX, <a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7fcacd095b1100ac337bb8e35798a7a5"></a><!-- doxytag: member="ONUMacCtl_NP::shiftStart1Slot" ref="a7fcacd095b1100ac337bb8e35798a7a5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5">ONUMacCtl_NP::shiftStart1Slot</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This method shifts the start register for one SuperSlot. </p>
<p>SuperSlot is defined as the summation of all the slot lengths. </p>
<div class="fragment"><pre class="fragment">                                  {

      uint64_t slotTime16ns = ((double)<a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a>/16)*<a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a>;

      EV &lt;&lt; <span class="stringliteral">&quot;Increasing Start Reg.: old=&quot;</span> &lt;&lt; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>
            &lt;&lt;<span class="stringliteral">&quot; + &quot;</span> &lt;&lt; slotTime16ns;

      <span class="comment">// NOTE: start_reg may OVERFLOW TOOooo...  tsouf</span>
      <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> = ((uint64_t)<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+slotTime16ns)%<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a>;


      EV&lt;&lt;<span class="stringliteral">&quot; = &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;<span class="stringliteral">&quot; Clock Now: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;endl;
      EV&lt;&lt;<span class="stringliteral">&quot;SlotLength: &quot;</span>&lt;&lt;slotTime16ns&lt;&lt;endl&lt;&lt;endl;


      <span class="comment">// Reschedule next TX</span>
      <a class="code" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a21d21569c768c65f20dddae0b305603d"></a><!-- doxytag: member="ONUMacCtl_NP::shiftStartXSlots" ref="a21d21569c768c65f20dddae0b305603d" args="(uint32_t X)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a21d21569c768c65f20dddae0b305603d">ONUMacCtl_NP::shiftStartXSlots</a> </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>X</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This method handles the start register when the module wakes up from SLEEP state and it has lost many SuperSlots. </p>
<div class="fragment"><pre class="fragment">                                             {
      uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a>/16*<a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a>;

      EV &lt;&lt; <span class="stringliteral">&quot;Increasing Start: old=&quot;</span> &lt;&lt; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>
            &lt;&lt;<span class="stringliteral">&quot; + &quot;</span> &lt;&lt; X*slotTime16ns;

      <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> = ((uint64_t)<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+X*slotTime16ns)%<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a>;


      EV&lt;&lt;<span class="stringliteral">&quot; = &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
      EV&lt;&lt;<span class="stringliteral">&quot;Lost Slots: &quot;</span>&lt;&lt;X&lt;&lt;<span class="stringliteral">&quot; SlotLength: &quot;</span>&lt;&lt;slotTime16ns&lt;&lt;endl&lt;&lt;endl;

      <span class="comment">// Reschedule next TX</span>
      <a class="code" href="classONUMacCtl__NP.html#a5eeae37afd1ce53b7245a3da0a91069b">scheduleStartTxPeriod</a>();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5731bf5d90c2876f256c6494d84c4a30"></a><!-- doxytag: member="ONUMacCtl_NP::startTxOnPON" ref="a5731bf5d90c2876f256c6494d84c4a30" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__NP.html#a5731bf5d90c2876f256c6494d84c4a30">ONUMacCtl_NP::startTxOnPON</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Directly called for start Messages and called if a frame arrives in IDLE. </p>
<p>Check to be sure...</p>
<p>Sometimes because we add 0.001 to startTx schedule, results to clock_reg = start+len +1</p>
<p>So, shift a slot.</p>
<p>Check that the MAC layer is not in TX mode</p>
<p>This happens because the 2 messages EndTransmission (<a class="el" href="classEPON__mac.html" title="EPON_mac class is actually the EtherMAC2 class modified.">EPON_mac</a>) and startTx (ONUMacCtl) are scheduled at the same EXACT time.</p>
<p>Some extra delay is used to avoid (internal) message collision This is set to 5*pow(10,simTime().getScaleExp()); (5*10^-12 in most cases). This reduces the collision times but do not eliminate them.</p>
<p>Therefore, when it happens we make the MacCtl to wait for the minimum frame transmission time (64Bytes)</p>
<p>Request next packet and set to IDLE state</p>
<p>Check That he allocated time is more than the frame... If it is not discart the frame, it is going to block all the rest...</p>

<p>Implements <a class="el" href="classONUMacCtlBase.html#accedb776fd223368fec60ebbf937f084">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">                               {
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>!=0) {
            std::cout&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_NP: SHIT: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Sim(ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>()&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Length: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>&lt;&lt;endl;
            <a class="code" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
            std::cout &lt;&lt; <span class="stringliteral">&quot;Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Length: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>&lt;&lt;endl;
            <span class="keywordflow">return</span>;
      }

      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#aa33e8db13b74bdf821d2b19d3be1ce4e" title="Pointer to the mac layer for some control and use of MAC address.">emac</a>-&gt;getQueueLength()&gt;0){
            EV&lt;&lt;<span class="stringliteral">&quot;DELAYing MAC busy: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
            cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            simtime_t delayTx = ((double)64*8)/<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>;
            simtime_t timerem;
            timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> ));
            <span class="keywordflow">if</span> (timerem&gt;delayTx){
                  scheduleAt(delayTx+simTime(), <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);

            }<span class="keywordflow">else</span>{
                  <a class="code" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
            }
            <span class="keywordflow">return</span>;
      }

      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.isEmpty()){
            <a class="code" href="classONUMacCtlBase.html#a824358e42beb5218bdbf3c56f314c119">queue_mod</a>-&gt;requestPacket();

            <span class="comment">// MPCP period</span>
            <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> == 0){
                  <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
                  EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
                  <span class="keywordflow">return</span>;
            }

            EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM _ON_ TO _IDLE_ (no message in tmp queue)\n&quot;</span>;
            <a class="code" href="classONUMacCtl__NP.html#ad16ac12e6930cc78d43894ba035efc0f">goToIDLE</a>();

            <span class="keywordflow">return</span>;
      }


      EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a041d250b612704bb53e5dd71cad3a436">getStateStr</a>()&lt;&lt;<span class="stringliteral">&quot; TO _ON_\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a4736ad0b388fe0fd16bf2620ec35e03d" title="Laser is ON and transmitting.">TX_ON</a>;

      uint32_t nextMsgSize =  ((cPacket *)<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.front())-&gt;getByteLength();


      <span class="comment">// Calculate TX and remaining time</span>
      <span class="comment">// NOTE: Change here for more bandwidth</span>
      <span class="keywordflow">if</span> (nextMsgSize&lt;64) nextMsgSize=64;
      uint32_t bytes=nextMsgSize+PREAMBLE_BYTES+SFD_BYTES;
      bytes+=INTERFRAME_GAP_BITS/8;

      <span class="comment">// TODO: Add laser on/off delay</span>
      simtime_t timereq = ((double)bytes*8)/<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>;
      EV &lt;&lt; <span class="stringliteral">&quot;Total Bytes: &quot;</span>&lt;&lt;bytes&lt;&lt;<span class="stringliteral">&quot; Total bits: &quot;</span>&lt;&lt;bytes*8&lt;&lt;<span class="stringliteral">&quot; TX RATE: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>&lt;&lt;endl;

      simtime_t timerem;
      timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> ));

      EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (sim): &quot;</span>&lt;&lt;timereq&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (sim): &quot;</span>&lt;&lt;timerem&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timereq.raw())&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timerem.raw())&lt;&lt;endl;
      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();

      <span class="comment">// If we dont have time break</span>
      <span class="keywordflow">if</span> (timerem&lt;timereq){
            simtime_t totaltime;
            totaltime.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> ));
            <span class="keywordflow">if</span> (totaltime&lt;timereq){
                  EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Frame is too big to FIT THE WHOLE TIME SLOT!\n&quot;</span>;
                  <span class="comment">// Discard and continue (the code)...</span>
                  <span class="comment">// TODO: Maybe add a counter!</span>
                  cancelAndDelete(dynamic_cast&lt;cMessage *&gt;(<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.pop()));
            }

            <span class="comment">// Log fragmented time</span>
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Fragmented TimeSlot... Frame is too big\n&quot;</span>;
            EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
            <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
            <a class="code" href="classONUMacCtlBase.html#a64cdaee4d78a117bf438910bbef96cbb">fragmentedTime</a> += timerem;

            <span class="comment">// Shift the start_reg</span>
            <a class="code" href="classONUMacCtl__NP.html#a7fcacd095b1100ac337bb8e35798a7a5" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
            <span class="comment">// cancel the stop message</span>
            <span class="comment">// (else we lose a time slot)</span>
            cancelEvent(<a class="code" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">stopTxMsg</a>);

            <span class="keywordflow">return</span>;
      }

      cPacket * msg = <span class="keyword">dynamic_cast&lt;</span>cPacket *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.pop());
      <span class="comment">// Check the user implementation of the Queues</span>
      <span class="keywordflow">if</span> (!msg){
            error(  <span class="stringliteral">&quot;Shit... we should never reach here: &quot;</span>
                        <span class="stringliteral">&quot;UNKNOWN message... NOT A cPACKET&quot;</span>);
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Add CURRENT TIME STAMP</span>
      <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *<span class="keyword">&gt;</span>(msg);
      <span class="keywordflow">if</span> (mpcp){
            mpcp-&gt;<a class="code" href="classMPCP.html#ae7828b734088f73c3b55adf0dfc1197e">setTs</a>(<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>);
      }

      <span class="comment">// We have enough time for the frame...</span>
      <span class="comment">//Send</span>
      send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
      <a class="code" href="classONUMacCtlBase.html#a562396f2fc470faf915fcb171fed0f42">numFramesFromHL</a>++;


      EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (RAW): \t&quot;</span>&lt;&lt;simTime().raw()&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(RAW): \t&quot;</span>&lt;&lt;simTime().raw() + timereq.raw()&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw())&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw() + timereq.raw())&lt;&lt;endl;
      simtime_t nextTx;
      <span class="comment">// LOOK at the NOTE on the begging</span>
      nextTx = simTime() + timereq;
      nextTx+= 5*pow(10,simTime().getScaleExp());
      cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      scheduleAt(nextTx, <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
}
</pre></div>
</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a91356d6f2777f8dd202f979d18c68f8e"></a><!-- doxytag: member="ONUMacCtl_NP::stopTxMsg" ref="a91356d6f2777f8dd202f979d18c68f8e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage* <a class="el" href="classONUMacCtl__NP.html#a91356d6f2777f8dd202f979d18c68f8e">ONUMacCtl_NP::stopTxMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="ONUMacCtl__NP_8h.html">ONUMacCtl_NP.h</a></li>
<li><a class="el" href="ONUMacCtl__NP_8cc.html">ONUMacCtl_NP.cc</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="classONUMacCtl__NP.html">ONUMacCtl_NP</a>      </li>

    <li class="footer">Generated on Wed Oct 31 2012 20:10:51 for EPONImplementationforOMNet++ by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
