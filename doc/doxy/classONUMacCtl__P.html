<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>EPONImplementationforOMNet++: ONUMacCtl_P Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">EPONImplementationforOMNet++
   &#160;<span id="projectnumber">0.8Beta</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('classONUMacCtl__P.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="#pro-attribs">Protected Attributes</a>  </div>
  <div class="headertitle">
<div class="title">ONUMacCtl_P Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ONUMacCtl_P" --><!-- doxytag: inherits="ONUMacCtlBase" -->
<p>TODO - Generated class.  
 <a href="classONUMacCtl__P.html#details">More...</a></p>

<p><code>#include &lt;ONUMacCtl_P.h&gt;</code></p>
<div class="dynheader">
Inheritance diagram for ONUMacCtl_P:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classONUMacCtl__P.png" usemap="#ONUMacCtl_P_map" alt=""/>
  <map id="ONUMacCtl_P_map" name="ONUMacCtl_P_map">
<area href="classONUMacCtlBase.html" alt="ONUMacCtlBase" shape="rect" coords="0,0,107,24"/>
</map>
 </div></div>

<p><a href="classONUMacCtl__P-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a011943ebbda51f826c755126370e4741">ONUMacCtl_P</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a73924a636ac359cccb5b9b0f8db81472">~ONUMacCtl_P</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a12e9e50584358ee3817c16edbb004d11">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a95f68cd3d914da42c3d252a41ae59249">startTxOnPON</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Directly called for start Messages and called if a frame arrives in IDLE.  <a href="#a95f68cd3d914da42c3d252a41ae59249"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a93f8a0146e49acd88212336e960cca52">handleMessage</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a1fecf3e8c2388c94349ca66276bb18fa">processFrameFromHigherLayer</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a9ad296d6ce28bbca8879d095befce343">processMPCP</a> (EthernetIIFrame *frame)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a77d64a22409070829fa8021e362f6b51">clockSync</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a3cbcfaed97e8bf8bef4c0accc3f38158">scheduleStartTxMsgFromRegister</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#add3ec22265704b94527eb2a09fe9e635">sendReport</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#acb5f01815ff99cc59baf7fd52a8ceed6">scheduleReport</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pro-attribs"></a>
Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="classONUQPerLLiDBase.html">ONUQPerLLiDBase</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>TODO - Generated class. </p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a011943ebbda51f826c755126370e4741"></a><!-- doxytag: member="ONUMacCtl_P::ONUMacCtl_P" ref="a011943ebbda51f826c755126370e4741" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classONUMacCtl__P.html#a011943ebbda51f826c755126370e4741">ONUMacCtl_P::ONUMacCtl_P</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                        {
      <a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;Send Report&quot;</span>, <a class="code" href="ONUMacCtl__P_8h.html#ae95ad8a1d8b4d3030cf22cebac200430">SEND_REPORT</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a73924a636ac359cccb5b9b0f8db81472"></a><!-- doxytag: member="ONUMacCtl_P::~ONUMacCtl_P" ref="a73924a636ac359cccb5b9b0f8db81472" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classONUMacCtl__P.html#a73924a636ac359cccb5b9b0f8db81472">ONUMacCtl_P::~ONUMacCtl_P</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                         {
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>)
            cancelAndDelete(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a>)
            cancelAndDelete(<a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a>);
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a77d64a22409070829fa8021e362f6b51"></a><!-- doxytag: member="ONUMacCtl_P::clockSync" ref="a77d64a22409070829fa8021e362f6b51" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a77d64a22409070829fa8021e362f6b51">ONUMacCtl_P::clockSync</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                           {
      EV &lt;&lt; <span class="stringliteral">&quot;\n\n============= CLOCK: &quot;</span>;
      <span class="comment">// NOTE: Clock is in sync with the simulation clock</span>
      <span class="comment">// a small skew can be added here (random)</span>


      <span class="comment">// Reset start/stop</span>
      uint32_t simT = <a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>();

      <span class="comment">// Update the clock</span>
      <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> = simT;
      EV &lt;&lt; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> &lt;&lt; <span class="stringliteral">&quot;=======================\n&quot;</span>;
      <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a93f8a0146e49acd88212336e960cca52"></a><!-- doxytag: member="ONUMacCtl_P::handleMessage" ref="a93f8a0146e49acd88212336e960cca52" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a93f8a0146e49acd88212336e960cca52">ONUMacCtl_P::handleMessage</a> </td>
          <td>(</td>
          <td class="paramtype">cMessage *&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
      <span class="comment">// Sync Clock</span>
      <a class="code" href="classONUMacCtl__P.html#a77d64a22409070829fa8021e362f6b51">clockSync</a>();

      <span class="comment">// Self Message</span>
      <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
      {
            EV &lt;&lt; <span class="stringliteral">&quot;Self-message &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; received\n&quot;</span>;

            <span class="keywordflow">if</span> (msg == <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>){
                  <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> == <a class="code" href="OLTMacCtl__NP_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>) {std::cout&lt;&lt;*msg&lt;&lt;endl; <span class="keyword">delete</span> msg; error(<span class="stringliteral">&quot;?&quot;</span>); }
                  <a class="code" href="classONUMacCtl__P.html#a95f68cd3d914da42c3d252a41ae59249" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;getKind()==<a class="code" href="ONUMacCtl__P_8h.html#ae95ad8a1d8b4d3030cf22cebac200430">SEND_REPORT</a>){
                  <a class="code" href="classONUMacCtl__P.html#add3ec22265704b94527eb2a09fe9e635">sendReport</a>();
            }
            <span class="keywordflow">else</span>
                  error(<span class="stringliteral">&quot;Unknown self message received!&quot;</span>);


            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Network Message</span>
      cGate *ingate = msg-&gt;getArrivalGate();
      EV &lt;&lt; <span class="stringliteral">&quot;Frame &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived on port &quot;</span> &lt;&lt; ingate-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;...\n&quot;</span>;

      <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;lowerLayerIn&quot;</span>)-&gt;getId()){
            <a class="code" href="classONUMacCtlBase.html#a25c02d7068d5311c39ac0b1faec3f1c6">processFrameFromMAC</a>(msg);
      }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;upperLayerIn&quot;</span>)-&gt;getId()){
            <a class="code" href="classONUMacCtl__P.html#a1fecf3e8c2388c94349ca66276bb18fa">processFrameFromHigherLayer</a>(msg);
      }<span class="keywordflow">else</span>{
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: Message came FROM THE WRONG DIRRECTION???? Dropping\n&quot;</span>;
            <span class="keyword">delete</span> msg;
      }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a12e9e50584358ee3817c16edbb004d11"></a><!-- doxytag: member="ONUMacCtl_P::initialize" ref="a12e9e50584358ee3817c16edbb004d11" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a12e9e50584358ee3817c16edbb004d11">ONUMacCtl_P::initialize</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reimplemented from <a class="el" href="classONUMacCtlBase.html#a0137cf8a14df90d754186fd668e45524">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">{
      <span class="comment">// Do the common stuff...</span>
      <a class="code" href="classONUMacCtl__P.html#a12e9e50584358ee3817c16edbb004d11">ONUMacCtlBase::initialize</a>();

      <span class="comment">// That will cause the ONU not to send REPORTs...</span>
      <a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a> = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classONUQPerLLiDBase.html" title="ONU_Q_mgmt_PerLLiD creates on queue per LLID.">ONUQPerLLiDBase</a> *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtlBase.html#a824358e42beb5218bdbf3c56f314c119">queue_mod</a>);

}
</pre></div>
</div>
</div>
<a class="anchor" id="a1fecf3e8c2388c94349ca66276bb18fa"></a><!-- doxytag: member="ONUMacCtl_P::processFrameFromHigherLayer" ref="a1fecf3e8c2388c94349ca66276bb18fa" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a1fecf3e8c2388c94349ca66276bb18fa">ONUMacCtl_P::processFrameFromHigherLayer</a> </td>
          <td>(</td>
          <td class="paramtype">cMessage *&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                                          {
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: Outgoing message, forwarding...\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#a562396f2fc470faf915fcb171fed0f42">numFramesFromHL</a>++;

      <span class="comment">// Pre-Configuration ... Check and send only MPCP</span>
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: Packet &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived from higher layers, sending\n&quot;</span>;
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> == 0 ){
            EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_P: Frame arrived in pre-conf stage &quot;</span>&lt;&lt;endl;

            <span class="comment">// Send only if it is an MPCP message</span>
            EthernetIIFrame * frame = <span class="keyword">dynamic_cast&lt;</span>EthernetIIFrame *<span class="keyword">&gt;</span>(msg);
            <span class="keywordflow">if</span> (frame &amp;&amp; frame-&gt;getEtherType() == <a class="code" href="MPCP__codes_8h.html#a01d93522186165aff8e9d9907b04aec3">MPCP_TYPE</a>){
                  send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
                  <span class="keywordflow">return</span>;
            }

            EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_P: DROPPING &quot;</span>&lt;&lt;endl;
            <span class="keyword">delete</span> msg;
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Check for a WAKE UP message</span>
      <span class="keywordflow">if</span> (msg-&gt;getKind() == <a class="code" href="OLTMacCtl__NP_8h.html#a3593b1b91fec6813d3d03abfee96f8e7">WAKEUPMSG</a>){
            EV &lt;&lt; <span class="stringliteral">&quot;Wake UP message received...&quot;</span> &lt;&lt; endl;
            <span class="comment">// Discard it...</span>
            <span class="keyword">delete</span> msg;

            <span class="comment">// Ignore WAKE UP if we are already transmitting</span>
            <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>-&gt;isScheduled()) <span class="keywordflow">return</span>;
      }<span class="keywordflow">else</span>{
            <span class="comment">// ENQUEUE</span>
            EV &lt;&lt; <span class="stringliteral">&quot;Queuing message...&quot;</span> &lt;&lt; endl;
            <a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.insert(msg);
      }


      <span class="comment">// Check clock and transmit only if it is our time</span>
      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;=<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>)
            <a class="code" href="classONUMacCtl__P.html#a95f68cd3d914da42c3d252a41ae59249" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();



}
</pre></div>
</div>
</div>
<a class="anchor" id="a9ad296d6ce28bbca8879d095befce343"></a><!-- doxytag: member="ONUMacCtl_P::processMPCP" ref="a9ad296d6ce28bbca8879d095befce343" args="(EthernetIIFrame *frame)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a9ad296d6ce28bbca8879d095befce343">ONUMacCtl_P::processMPCP</a> </td>
          <td>(</td>
          <td class="paramtype">EthernetIIFrame *&#160;</td>
          <td class="paramname"><em>frame</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Implements <a class="el" href="classONUMacCtlBase.html#a73e2d245fd886ba3f53ab59df9feaca3">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">                                                    {
      EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: MPCP Frame processing\n&quot;</span>;
      <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = check_and_cast&lt;<a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *&gt;(frame);

      <span class="keywordflow">switch</span> (mpcp-&gt;<a class="code" href="classMPCP.html#a68374d0a62fbdd1c40f264f1a9a9230b">getOpcode</a>())
      {

            <span class="keywordflow">case</span> <a class="code" href="MPCP__codes_8h.html#a190716814784e1e13cfd09ef6e773f5d">MPCP_GATE</a>:
            {
                  <a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> * gate = check_and_cast&lt;<a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> *&gt;(frame);
                  EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: Type is MPCP_GATE\n&quot;</span>;

                  <span class="keywordflow">if</span> (gate-&gt;<a class="code" href="classMPCPGate.html#aa568e79e9c26b388d9e291ccd76db8c5">getListLen</a>() == 0) {
                        EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: !!! NO ALLOCATION FOR US :-( (bitches...)&quot;</span>;
                        <span class="keywordflow">break</span>;
                  }

                  <span class="keywordflow">if</span> (gate-&gt;<a class="code" href="classMPCPGate.html#aa568e79e9c26b388d9e291ccd76db8c5">getListLen</a>() == 1 &amp;&amp;
                        gate-&gt;getDest().isBroadcast()) {

                        EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: MPCP Registration! Ignoring...&quot;</span>;
                        <span class="keywordflow">break</span>;
                  }


                  <span class="comment">// Update with 1st alloc</span>
                  <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a188d0342a2fb1c02190fc079aa2b20d9">getStartTime</a>(0);
                  <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a3b82c4a4e1246e2170e49451690d9efe">getDuration</a>(0);
                  <a class="code" href="classONUMacCtlBase.html#adbc208f6eb55fbd4fcd4512133b47eb7">slotLength</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a568ad27f81f61ff5bb0eb5d1b6aad9b9">getSlotTime</a>();
                  <a class="code" href="classONUMacCtlBase.html#ab0b101eecf208acb79feeb0732047f87">slotNumber</a> = gate-&gt;<a class="code" href="classMPCPGate.html#ab25cbd133a2cf312e62abe9d80aa5d8d">getSlotsNum</a>();

                  <span class="comment">// Start Tx since we have been polled...</span>
                  <span class="comment">// DO NOT call startTxOnPON() cause the allocation</span>
                  <span class="comment">// may be in the future...</span>
                  <a class="code" href="classONUMacCtl__P.html#a3cbcfaed97e8bf8bef4c0accc3f38158">scheduleStartTxMsgFromRegister</a>();


                  <span class="comment">// Schedule the report</span>
                  <a class="code" href="classONUMacCtl__P.html#acb5f01815ff99cc59baf7fd52a8ceed6">scheduleReport</a>();


                  <a class="code" href="classONUMacCtlBase.html#a13bae0a24f63d7823a8a8917ca95512f">numGates</a>++;
                  <span class="keywordflow">break</span>;
            }
            <span class="keywordflow">default</span>:
                  <span class="keywordflow">break</span>;
      };
}
</pre></div>
</div>
</div>
<a class="anchor" id="acb5f01815ff99cc59baf7fd52a8ceed6"></a><!-- doxytag: member="ONUMacCtl_P::scheduleReport" ref="acb5f01815ff99cc59baf7fd52a8ceed6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#acb5f01815ff99cc59baf7fd52a8ceed6">ONUMacCtl_P::scheduleReport</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                {
      <span class="comment">// Nothing we can do...</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>==NULL) <span class="keywordflow">return</span>;

      <span class="comment">// ... +12 for the IFG</span>
      uint16_t repsize = <a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>-&gt;<a class="code" href="classONUQPerLLiDBase.html#aa868acd8e446143d07120901ed7ea90b" title="Return the MPCP Report Size in Bytes.">getMPCPRepSize</a>()+12;

      EV &lt;&lt; <span class="stringliteral">&quot;REPORT SIZE: &quot;</span>&lt;&lt;repsize&lt;&lt;<span class="stringliteral">&quot; ns16=&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#adb2bf3f82cc100f30e2900963a59d27c" title="Convert bytes to ns16.">MPCPTools::bytesToNS16</a>(repsize, 1)&lt;&lt;endl;
      simtime_t timereq_rep;
      timereq_rep.setRaw(<a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(
                                    <a class="code" href="classMPCPTools.html#adb2bf3f82cc100f30e2900963a59d27c" title="Convert bytes to ns16.">MPCPTools::bytesToNS16</a>(repsize, 1)
                                ));
      simtime_t slotend;
      <span class="comment">// Offset from now to slot end</span>
      uint32_t sendoffset = (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>)-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>;
      <span class="comment">// end of slot in sec</span>
      slotend.setRaw(<a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(sendoffset));
      slotend = simTime()+slotend;

      EV &lt;&lt; <span class="stringliteral">&quot;Required time: &quot;</span>&lt;&lt;timereq_rep&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;Slot ends at: &quot;</span>&lt;&lt;slotend&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;Scheduling REPORT at: &quot;</span>&lt;&lt;slotend-timereq_rep&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;NOW: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
      scheduleAt(slotend-timereq_rep, <a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a>);

}
</pre></div>
</div>
</div>
<a class="anchor" id="a3cbcfaed97e8bf8bef4c0accc3f38158"></a><!-- doxytag: member="ONUMacCtl_P::scheduleStartTxMsgFromRegister" ref="a3cbcfaed97e8bf8bef4c0accc3f38158" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a3cbcfaed97e8bf8bef4c0accc3f38158">ONUMacCtl_P::scheduleStartTxMsgFromRegister</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                                {
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>-&gt;isScheduled())
            cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);

      <span class="comment">// Start is in the past... schedule NOW</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>)
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: WARNING: MPCP GATE WITH START REG IN THE PAST!!!&quot;</span>&lt;&lt;endl;
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>){
            scheduleAt(simTime(), <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Start in the PAST: MISSED TIMESLOT!</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>){
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_P: WARNING: MISSED SLOT ... clock &gt; start+len!!!&quot;</span>&lt;&lt;endl;
            <span class="keywordflow">return</span>;
      }


      <span class="comment">// Calc. the difference between clock and start</span>
      uint diff = <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> - <a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>;
      simtime_t simoffset;
      simoffset.setRaw(<a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(diff));

      EV&lt;&lt;<span class="stringliteral">&quot;Scheduling StartTxMsg in future: diff=&quot;</span>&lt;&lt;diff&lt;&lt;<span class="stringliteral">&quot; simoffset=&quot;</span>&lt;&lt;simoffset&lt;&lt;endl;
      scheduleAt(simTime()+simoffset, <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);

}
</pre></div>
</div>
</div>
<a class="anchor" id="add3ec22265704b94527eb2a09fe9e635"></a><!-- doxytag: member="ONUMacCtl_P::sendReport" ref="add3ec22265704b94527eb2a09fe9e635" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#add3ec22265704b94527eb2a09fe9e635">ONUMacCtl_P::sendReport</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                            {
      <span class="comment">// StartTxOnPon will handle the report</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>-&gt;isScheduled()) <span class="keywordflow">return</span>;

      EV &lt;&lt; <span class="stringliteral">&quot;*** Sending MPCP REPORT ***&quot;</span>&lt;&lt;endl;
      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();
      <span class="comment">// enqueue the frame (in case the Q layer is empty!)</span>
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.length()==0)
            <a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.insert(<a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>-&gt;<a class="code" href="classONUQPerLLiDBase.html#a8dab2bf2c6295f4c4532a9a6f97675b1" title="Return an MPCP REPORT with the status of the queues.">requestMPCP_REPORT</a>());
      <span class="comment">// trigger tx</span>
      <a class="code" href="classONUMacCtl__P.html#a95f68cd3d914da42c3d252a41ae59249" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.length()==1){
            EV &lt;&lt; <span class="stringliteral">&quot;*** Removing MPCP REPORT: StartTx re-aquired it ***&quot;</span>&lt;&lt;endl;
            <span class="keyword">delete</span> <a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.pop();
      }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a95f68cd3d914da42c3d252a41ae59249"></a><!-- doxytag: member="ONUMacCtl_P::startTxOnPON" ref="a95f68cd3d914da42c3d252a41ae59249" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classONUMacCtl__P.html#a95f68cd3d914da42c3d252a41ae59249">ONUMacCtl_P::startTxOnPON</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Directly called for start Messages and called if a frame arrives in IDLE. </p>
<p>Check to be sure... THIS SHOULD NEVER HAPPEN</p>
<p>Check that the MAC layer is not in TX mode</p>
<p>This happens because the 2 messages EndTransmission (<a class="el" href="classEPON__mac.html" title="EPON_mac class is actually the EtherMAC2 class modified.">EPON_mac</a>) and startTx (ONUMacCtl) are scheduled at the same EXACT time.</p>
<p>Some extra delay is used to avoid (internal) message collision This is set to 5*pow(10,simTime().getScaleExp()); (5*10^-12 in most cases). This reduces the collision times but do not eliminate them.</p>
<p>Therefore, when it happens we make the MacCtl to wait for the minimum frame transmission time (64Bytes)</p>
<p>Request next packet and set to IDLE state</p>
<p>Before requesting data packet check if we should send REPORT</p>
<p>Check That he allocated time is more than the frame... If it is not discard the frame, it is going to block all the rest...</p>

<p>Implements <a class="el" href="classONUMacCtlBase.html#accedb776fd223368fec60ebbf937f084">ONUMacCtlBase</a>.</p>
<div class="fragment"><pre class="fragment">                              {
      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&gt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> &amp;&amp; <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>!=0) {
            std::cout&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl_P: SHIT: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Sim(ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>()&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>&lt;&lt;endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Length: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>&lt;&lt;endl;
            <span class="keywordflow">return</span>;
      }

      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#aa33e8db13b74bdf821d2b19d3be1ce4e" title="Pointer to the mac layer for some control and use of MAC address.">emac</a>-&gt;getQueueLength()&gt;0){
            EV&lt;&lt;<span class="stringliteral">&quot;DELAYing MAC busy: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
            std::cout&lt;&lt;<span class="stringliteral">&quot;DELAYing MAC busy: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
            cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            simtime_t delayTx = ((double)64*8)/<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>;
            simtime_t timerem;
            timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> ));
            <span class="keywordflow">if</span> (timerem&gt;delayTx)
                  scheduleAt(delayTx+simTime(), <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
            <span class="keywordflow">return</span>;
      }



      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.isEmpty()){
            <a class="code" href="classONUMacCtlBase.html#a824358e42beb5218bdbf3c56f314c119">queue_mod</a>-&gt;requestPacket();

            <span class="comment">// MPCP period</span>
            <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a> == 0){
                  <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
                  EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_P: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
                  <span class="keywordflow">return</span>;
            }

            EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_P: CHANGING STATE FROM _ON_ TO _IDLE_ (no message in tmp queue)\n&quot;</span>;

            <span class="keywordflow">return</span>;
      }


      EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_P: CHANGING STATE FROM &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#a041d250b612704bb53e5dd71cad3a436">getStateStr</a>()&lt;&lt;<span class="stringliteral">&quot; TO _ON_\n&quot;</span>;
      <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a4736ad0b388fe0fd16bf2620ec35e03d" title="Laser is ON and transmitting.">TX_ON</a>;

      uint32_t nextMsgSize =  ((cPacket *)<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.front())-&gt;getByteLength();



      <span class="comment">// Calculate TX and remaining time</span>
      <span class="comment">// NOTE: Change here for more bandwidth</span>
      <span class="keywordflow">if</span> (nextMsgSize&lt;64) nextMsgSize=64;
      uint32_t bytes=nextMsgSize+PREAMBLE_BYTES+SFD_BYTES;
      bytes+=INTERFRAME_GAP_BITS/8;

      <span class="comment">// TODO: Add laser on/off delay</span>
      <span class="comment">// TODO: Make a method in MPCPTools for this... (bytes to simtime)</span>
      simtime_t timereq = ((double)bytes*8)/<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>;
      EV &lt;&lt; <span class="stringliteral">&quot;Total Bytes: &quot;</span>&lt;&lt;bytes&lt;&lt;<span class="stringliteral">&quot; Total bits: &quot;</span>&lt;&lt;bytes*8&lt;&lt;<span class="stringliteral">&quot; TX RATE: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtlBase.html#add9425e1d96fe371068c89feaab41b7b" title="Tx Rate TODO: make it a parameter.">txrate</a>&lt;&lt;endl;

      simtime_t timerem;
      timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a12acb2413a73ef23daddb21a1060b8f2">start_reg</a>+<a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a>-<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a> ));

      <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>!=NULL){
            uint16_t repsize = <a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>-&gt;<a class="code" href="classONUQPerLLiDBase.html#aa868acd8e446143d07120901ed7ea90b" title="Return the MPCP Report Size in Bytes.">getMPCPRepSize</a>();

            simtime_t timereq_rep;
            timereq_rep.setRaw(<a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(
                                          <a class="code" href="classMPCPTools.html#adb2bf3f82cc100f30e2900963a59d27c" title="Convert bytes to ns16.">MPCPTools::bytesToNS16</a>(repsize, 1)
                                      ));
            <span class="comment">// Total time for both packets</span>
            simtime_t totaltime = timereq_rep+timereq;

            <span class="comment">// only one can be send... so send the REPORT</span>
            <span class="keywordflow">if</span> (totaltime&gt;=timerem){
                  EV &lt;&lt; <span class="stringliteral">&quot;*** Total Req time (sim): &quot;</span>&lt;&lt;totaltime&lt;&lt;endl;
                  EV &lt;&lt; <span class="stringliteral">&quot;*** Remaining time (sim): &quot;</span>&lt;&lt;timerem&lt;&lt;endl;
                  EV &lt;&lt; <span class="stringliteral">&quot;*** Sending MPCP REPORT : &quot;</span>&lt;&lt;timereq_rep&lt;&lt;endl;
                  send(<a class="code" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">qpl</a>-&gt;<a class="code" href="classONUQPerLLiDBase.html#a8dab2bf2c6295f4c4532a9a6f97675b1" title="Return an MPCP REPORT with the status of the queues.">requestMPCP_REPORT</a>(), <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);

                  <a class="code" href="classONUMacCtlBase.html#a562396f2fc470faf915fcb171fed0f42">numFramesFromHL</a>++;

                  <span class="comment">// no need to reschedule startTx...</span>
                  <span class="comment">// end of time slot</span>

                  <span class="comment">// cancel tho report sending</span>
                  <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a>-&gt;isScheduled()) cancelEvent(<a class="code" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">sendReportMsg</a>);
                  <span class="keywordflow">return</span>;
            }
      }

      EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (sim): &quot;</span>&lt;&lt;timereq&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (sim): &quot;</span>&lt;&lt;timerem&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timereq.raw())&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timerem.raw())&lt;&lt;endl;
      <a class="code" href="classONUMacCtlBase.html#ad078503eedc052e38ee2363005a4c841">dumpReg</a>();

      <span class="comment">// If we dont have time break</span>
      <span class="keywordflow">if</span> (timerem&lt;timereq){
            simtime_t totaltime;
            totaltime.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtlBase.html#a9f33b8e3c4a430187da32eb7b3024635">len_reg</a> ));
            <span class="keywordflow">if</span> (totaltime&lt;timereq){
                  EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Frame is too big to FIT THE WHOLE TIME SLOT!\n&quot;</span>;
                  <span class="comment">// Discard and continue (the code)...</span>
                  <span class="comment">// TODO: Maybe add a counter!</span>
                  cancelAndDelete(dynamic_cast&lt;cMessage *&gt;(<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.pop()));
            }

            <span class="comment">// Log fragmented time</span>
            EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl_NP: Fragmented TimeSlot... Frame is too big\n&quot;</span>;
            EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl_NP: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
            <a class="code" href="classONUMacCtlBase.html#ab4c5dac84f2fd65010f28eed3393b649">transmitState</a> = <a class="code" href="ONUMacCtlBase_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
            <a class="code" href="classONUMacCtlBase.html#a64cdaee4d78a117bf438910bbef96cbb">fragmentedTime</a> += timerem;

            <span class="comment">// ON SHIFTING HERE</span>

            <span class="keywordflow">return</span>;
      }

      cPacket * msg = <span class="keyword">dynamic_cast&lt;</span>cPacket *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtlBase.html#ab0bf602caed978d962282eb529c10ae8">tmp_queue</a>.pop());
      <span class="comment">// Check the user implementation of the Queues</span>
      <span class="keywordflow">if</span> (!msg){
            error(  <span class="stringliteral">&quot;Shit... we should never reach here: &quot;</span>
                        <span class="stringliteral">&quot;UNKNOWN message... NOT A cPACKET&quot;</span>);
            <span class="keywordflow">return</span>;
      }

      <span class="comment">// Add CURRENT TIME STAMP</span>
      <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *<span class="keyword">&gt;</span>(msg);
      <span class="keywordflow">if</span> (mpcp){
            mpcp-&gt;<a class="code" href="classMPCP.html#ae7828b734088f73c3b55adf0dfc1197e">setTs</a>(<a class="code" href="classONUMacCtlBase.html#a5ba39000daa630fdd573fd001d05040d">clock_reg</a>);
      }

      <span class="comment">// We have enough time for the frame...</span>
      <span class="comment">//Send</span>
      send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
      numFramesFromHL++;


      EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (RAW): \t&quot;</span>&lt;&lt;simTime().raw()&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(RAW): \t&quot;</span>&lt;&lt;simTime().raw() + timereq.raw()&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw())&lt;&lt;endl;
      EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw() + timereq.raw())&lt;&lt;endl;
      simtime_t nextTx;
      <span class="comment">// LOOK at the NOTE at the top...</span>
      nextTx = simTime() + timereq;
      nextTx+= 5*pow(10,simTime().getScaleExp());
      cancelEvent(<a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
      scheduleAt(nextTx, <a class="code" href="classONUMacCtlBase.html#ab3958b57b1ac0e0ac910c9522f2e4f42">startTxMsg</a>);
}
</pre></div>
</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="ac07afdfceb50c71a72a9d6cdeec5ba96"></a><!-- doxytag: member="ONUMacCtl_P::qpl" ref="ac07afdfceb50c71a72a9d6cdeec5ba96" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classONUQPerLLiDBase.html">ONUQPerLLiDBase</a>* <a class="el" href="classONUMacCtl__P.html#ac07afdfceb50c71a72a9d6cdeec5ba96">ONUMacCtl_P::qpl</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a0abdd0699575bf70d2a5f47b28784e08"></a><!-- doxytag: member="ONUMacCtl_P::sendReportMsg" ref="a0abdd0699575bf70d2a5f47b28784e08" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage* <a class="el" href="classONUMacCtl__P.html#a0abdd0699575bf70d2a5f47b28784e08">ONUMacCtl_P::sendReportMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="ONUMacCtl__P_8h.html">ONUMacCtl_P.h</a></li>
<li><a class="el" href="ONUMacCtl__P_8cc.html">ONUMacCtl_P.cc</a></li>
</ul>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="classONUMacCtl__P.html">ONUMacCtl_P</a>      </li>

    <li class="footer">Generated on Wed Oct 31 2012 20:10:52 for EPONImplementationforOMNet++ by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
