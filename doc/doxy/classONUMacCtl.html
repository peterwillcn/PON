<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EPONImplementationforOMNet++: ONUMacCtl Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>ONUMacCtl Class Reference</h1><!-- doxytag: class="ONUMacCtl" -->
<p><a class="el" href="classONUMacCtl.html" title="ONUMacCtl class controls the below MAC layer transmission times.">ONUMacCtl</a> class controls the below MAC layer transmission times.  
<a href="#_details">More...</a></p>

<p><code>#include &lt;ONUMacCtl.h&gt;</code></p>

<p><a href="classONUMacCtl-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a1accaf3707a591d312508f585ed4f3d2">ONUMacCtl</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a284cdea63d6f645061d2308c157c48dd">~ONUMacCtl</a> ()</td></tr>
<tr><td colspan="2"><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a63331ffcbc1f7055b2ce1676f5030988">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a625847b8dab03bcdd517e975ec01a870">finish</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aeabdc0ad1691c1f0c3aad9737b3f3ba7">handleMessage</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#ae8d8b158574a5613dda636fe89c32648">processFrameFromHigherLayer</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a26a9359fab07d7d925d61cebf0c97717">processFrameFromMAC</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a1bda479d4f9746f6abb34328793b24ac">processMPCP</a> (EthernetIIFrame *frame)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a3a9f9c2e73158215f5863f7c2c2d59a6">scheduleStopTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#ad67286c75033f0c90f5ba258d5acb8b9">startTxOnPON</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Directly called for start Messages and called if a frame arrives in IDLE.  <a href="#ad67286c75033f0c90f5ba258d5acb8b9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aa245610a1fcf7a66e46f7d9d62cd5cdb">handleStopTxPeriod</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a6832c72c2df26d43ff0274be32f4f0b6">clockSync</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update the clock.  <a href="#a6832c72c2df26d43ff0274be32f4f0b6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aba20100031d2efa7c7cf3f96756ed5e1">shiftStart1Slot</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This method shifts the start register for one SuperSlot.  <a href="#aba20100031d2efa7c7cf3f96756ed5e1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a8a9803013bbe23685f2784a7adf97636">shiftStartXSlots</a> (uint32_t X)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This method handles the start register when the module wakes up from SLEEP state and it has lost many SuperSlots.  <a href="#a8a9803013bbe23685f2784a7adf97636"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a81c8e32f236ce95bf4b6831f84ca04e1">dumpReg</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual cModule *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a3e387bb4cfe4af3bdb2cc8b37d9c4b55">getNeighbourOnGate</a> (const char *gate)</td></tr>
<tr><td colspan="2"><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint64_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61">txrate</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Tx Rate TODO: make it a parameter.  <a href="#a8ed7b330c8432443882619613ab3ee61"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="classEPON__mac.html">EPON_mac</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08">emac</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Pointer to the mac layer for some control and use of MAC address.  <a href="#a46b25de817b0427f1fc9d10e95d66d08"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aec7348c33d5d4638d4456a6171604182">RTT</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a6521093d62dabc080cb69eb259e7bbbe">numGates</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aab7a8be5d32d2da0e9eb412bafacd2d9">syncMsg</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">IPassiveQueue *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">queue_mod</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cQueue&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">numFramesFromHLDropped</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">simtime_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">fragmentedTime</a></td></tr>
<tr><td colspan="2"><h2>Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#a93a1b30420857d24af3b3f15aa5678d1">goToIDLE</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classONUMacCtl.html#ac76f654e1e19537817c371c9f9a8d10f">goToSLEEP</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p><a class="el" href="classONUMacCtl.html" title="ONUMacCtl class controls the below MAC layer transmission times.">ONUMacCtl</a> class controls the below MAC layer transmission times. </p>
<p>This version is fairly more complicated from the OLT one because we have transmit in specific times. The module can come to IDLE or SLEEP states which means that the clock and the start register are left back. (The clock is updated on each message reception).</p>
<p>Also this class has a pointer to the EPON_Q_mgmt module and it uses it as a simple queue in order to get frames. Finally note that missing mac addresses and LLIDs (from frames) are filled in here, cause the lower layer expects them. </p>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a1accaf3707a591d312508f585ed4f3d2"></a><!-- doxytag: member="ONUMacCtl::ONUMacCtl" ref="a1accaf3707a591d312508f585ed4f3d2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ONUMacCtl::ONUMacCtl </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00020"></a>00020                     {
<a name="l00021"></a>00021         <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>=0;
<a name="l00022"></a>00022         <a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>=0;
<a name="l00023"></a>00023         <a class="code" href="classONUMacCtl.html#aab7a8be5d32d2da0e9eb412bafacd2d9">syncMsg</a>=0;
<a name="l00024"></a>00024 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a284cdea63d6f645061d2308c157c48dd"></a><!-- doxytag: member="ONUMacCtl::~ONUMacCtl" ref="a284cdea63d6f645061d2308c157c48dd" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ONUMacCtl::~ONUMacCtl </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00026"></a>00026                      {
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         cancelAndDelete(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00029"></a>00029         cancelAndDelete(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00030"></a>00030         cancelAndDelete(<a class="code" href="classONUMacCtl.html#aab7a8be5d32d2da0e9eb412bafacd2d9">syncMsg</a>);
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 }
</pre></div></p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a6832c72c2df26d43ff0274be32f4f0b6"></a><!-- doxytag: member="ONUMacCtl::clockSync" ref="a6832c72c2df26d43ff0274be32f4f0b6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::clockSync </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update the clock. </p>
<p>Note that the clock can be reseted back to 0 (zero) cause it is define by <a class="el" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> as 32bit register (of 16 nanoseconds granularity). This is also handled here. </p>

<p><p>Multi shift</p>
<p>Check Slot Shift... NOTE: skew introduced</p>
</p>

<p><div class="fragment"><pre class="fragment"><a name="l00552"></a>00552                          {
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         EV &lt;&lt; <span class="stringliteral">&quot;\n\n============= CLOCK: &quot;</span>;
<a name="l00555"></a>00555         <span class="comment">// NOTE: Clock is in sync with the simulation clock</span>
<a name="l00556"></a>00556         <span class="comment">// a small skew can be added here (random)</span>
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <span class="comment">// Reset start/stop</span>
<a name="l00560"></a>00560         uint32_t simT = <a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>();
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         <span class="comment">// No clock shift</span>
<a name="l00564"></a>00564         <span class="keywordflow">if</span> (simT&gt;=<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>){
<a name="l00565"></a>00565                 <span class="comment">// Update the clock</span>
<a name="l00566"></a>00566                 <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> = simT;
<a name="l00567"></a>00567                 EV &lt;&lt; <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> &lt;&lt; <span class="stringliteral">&quot;=======================\n&quot;</span>;
<a name="l00568"></a>00568                 <span class="keywordflow">return</span>;
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;simT){
<a name="l00573"></a>00573                 EV &lt;&lt; <span class="stringliteral">&quot;MULTI SHIFT =====================\n&quot;</span> &lt;&lt;endl;
<a name="l00574"></a>00574                 <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> = simT;
<a name="l00575"></a>00575                 <span class="comment">// Super Slot ...</span>
<a name="l00576"></a>00576                 uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a>/16*<a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a>;
<a name="l00577"></a>00577                 uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> - <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>)/slotTime16ns);
<a name="l00578"></a>00578                 <a class="code" href="classONUMacCtl.html#a8a9803013bbe23685f2784a7adf97636" title="This method handles the start register when the module wakes up from SLEEP state...">shiftStartXSlots</a>(lostSlots);
<a name="l00579"></a>00579                 <span class="keywordflow">return</span>;
<a name="l00580"></a>00580         }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <span class="comment">// Single shift (1 reg loop)</span>
<a name="l00583"></a>00583 
<a name="l00589"></a>00589         <span class="comment">// Reschedule the clock</span>
<a name="l00590"></a>00590         <span class="comment">// In ANY case start reg is wrong</span>
<a name="l00591"></a>00591         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00592"></a>00592         cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00593"></a>00593         cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         EV &lt;&lt; <span class="stringliteral">&quot; SHIFT =======================\n&quot;</span>;
<a name="l00596"></a>00596 <span class="comment">//      dumpReg();</span>
<a name="l00597"></a>00597 <span class="comment">//      uint64_t superSlotTime16ns = ((double)slotLength/16)*slotNumber;</span>
<a name="l00598"></a>00598 <span class="comment">//      uint32_t remclk = MPCP_CLOCK_MAX - clock_reg;</span>
<a name="l00599"></a>00599 <span class="comment">//      EV &lt;&lt; &quot;Remaining Clock: &quot;&lt;&lt; remclk&lt;&lt;endl;</span>
<a name="l00600"></a>00600 <span class="comment">//      EV &lt;&lt; &quot;Time Lost: &quot;&lt;&lt; simT+remclk &lt;&lt;endl;</span>
<a name="l00601"></a>00601 <span class="comment">//      uint64_t spSlotsLost       = ceil((double)( simT+remclk )/superSlotTime16ns);</span>
<a name="l00602"></a>00602 <span class="comment">//      EV &lt;&lt; &quot;Slots Lost: &quot;&lt;&lt; spSlotsLost &lt;&lt;endl;</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="comment">// Update the clock</span>
<a name="l00605"></a>00605         <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> = simT;
<a name="l00606"></a>00606 <span class="comment">//      shiftStartXSlots(spSlotsLost);</span>
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <a class="code" href="classONUMacCtl.html#a81c8e32f236ce95bf4b6831f84ca04e1">dumpReg</a>();
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="comment">// We are IN the transmission area</span>
<a name="l00611"></a>00611 <span class="comment">//      if (clock_reg&gt;=start_reg &amp;&amp; clock_reg &lt; start_reg+len_reg){</span>
<a name="l00612"></a>00612 <span class="comment">//              EV &lt;&lt; &quot;.... IN TX PERIOD &quot;&lt;&lt;endl;</span>
<a name="l00613"></a>00613 <span class="comment">//              startTxOnPON();</span>
<a name="l00614"></a>00614 <span class="comment">//      // We are in the same slot AFTER the tx area</span>
<a name="l00615"></a>00615 <span class="comment">//      }else if (clock_reg&gt;start_reg+len_reg){</span>
<a name="l00616"></a>00616 <span class="comment">//              EV &lt;&lt; &quot; .... SHIFT IS NEEDED &quot;&lt;&lt;endl;</span>
<a name="l00617"></a>00617 <span class="comment">//              shiftStart1Slot();</span>
<a name="l00618"></a>00618 <span class="comment">//      // We are in the same slot BEFORE the tx area</span>
<a name="l00619"></a>00619 <span class="comment">//      }else {</span>
<a name="l00620"></a>00620 <span class="comment">//              EV &lt;&lt; &quot;.... SCHED. NEXT PERIOD &quot;&lt;&lt;endl;</span>
<a name="l00621"></a>00621 <span class="comment">//              scheduleStartTxPeriod();</span>
<a name="l00622"></a>00622 <span class="comment">//      }</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         EV &lt;&lt; <span class="stringliteral">&quot;===========================================\n\n\n&quot;</span>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a81c8e32f236ce95bf4b6831f84ca04e1"></a><!-- doxytag: member="ONUMacCtl::dumpReg" ref="a81c8e32f236ce95bf4b6831f84ca04e1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::dumpReg </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00667"></a>00667                        {
<a name="l00668"></a>00668         EV &lt;&lt; <span class="stringliteral">&quot;Sim(ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>()&lt;&lt;endl;
<a name="l00669"></a>00669         EV &lt;&lt; <span class="stringliteral">&quot;Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&lt;&lt;endl;
<a name="l00670"></a>00670         EV &lt;&lt; <span class="stringliteral">&quot;Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;&lt;endl;
<a name="l00671"></a>00671         EV &lt;&lt; <span class="stringliteral">&quot;Length: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>&lt;&lt;endl;
<a name="l00672"></a>00672 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a625847b8dab03bcdd517e975ec01a870"></a><!-- doxytag: member="ONUMacCtl::finish" ref="a625847b8dab03bcdd517e975ec01a870" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::finish </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00677"></a>00677 {
<a name="l00678"></a>00678     simtime_t t = simTime();
<a name="l00679"></a>00679     recordScalar(<span class="stringliteral">&quot;simulated time&quot;</span>, t);
<a name="l00680"></a>00680     recordScalar(<span class="stringliteral">&quot;messages handled&quot;</span>, <a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>+<a class="code" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a>);
<a name="l00681"></a>00681     recordScalar(<span class="stringliteral">&quot;Dropped Frames From HL&quot;</span>, <a class="code" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">numFramesFromHLDropped</a>);
<a name="l00682"></a>00682     <span class="keywordtype">double</span> fragBits = <a class="code" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">fragmentedTime</a>.dbl()/(1/GIGABIT_ETHERNET_TXRATE);
<a name="l00683"></a>00683     recordScalar(<span class="stringliteral">&quot;FragmentedBits&quot;</span>, fragBits);
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (t&gt;0) {
<a name="l00685"></a>00685         recordScalar(<span class="stringliteral">&quot;frames/sec&quot;</span>, (<a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>+<a class="code" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a>)/t);
<a name="l00686"></a>00686         recordScalar(<span class="stringliteral">&quot;drops/sec&quot;</span>, <a class="code" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">numFramesFromHLDropped</a>/t);
<a name="l00687"></a>00687         recordScalar(<span class="stringliteral">&quot;FragmentedBits/sec&quot;</span>, fragBits/t);
<a name="l00688"></a>00688     }
<a name="l00689"></a>00689 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3e387bb4cfe4af3bdb2cc8b37d9c4b55"></a><!-- doxytag: member="ONUMacCtl::getNeighbourOnGate" ref="a3e387bb4cfe4af3bdb2cc8b37d9c4b55" args="(const char *gate)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cModule * ONUMacCtl::getNeighbourOnGate </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>gate</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00691"></a>00691                                                      {
<a name="l00692"></a>00692         <span class="keywordflow">return</span> gate(g)-&gt;getNextGate()-&gt;getOwnerModule();
<a name="l00693"></a>00693 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a93a1b30420857d24af3b3f15aa5678d1"></a><!-- doxytag: member="ONUMacCtl::goToIDLE" ref="a93a1b30420857d24af3b3f15aa5678d1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::goToIDLE </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00379"></a>00379                         {
<a name="l00380"></a>00380         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="OLTMacCtl_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>;
<a name="l00381"></a>00381         cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00382"></a>00382         cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00383"></a>00383         <a class="code" href="classONUMacCtl.html#a3a9f9c2e73158215f5863f7c2c2d59a6">scheduleStopTxPeriod</a>();
<a name="l00384"></a>00384 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac76f654e1e19537817c371c9f9a8d10f"></a><!-- doxytag: member="ONUMacCtl::goToSLEEP" ref="ac76f654e1e19537817c371c9f9a8d10f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::goToSLEEP </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00386"></a>00386                          {
<a name="l00387"></a>00387         EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM ?? TO _SLEEP_\n&quot;</span>;
<a name="l00388"></a>00388         <a class="code" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">queue_mod</a>-&gt;requestPacket();
<a name="l00389"></a>00389         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#aa22f344687606a775a3466beffd86e77" title="It may or may not be our turn BUT ALL Qs ARE EMPTY (no need to schedule startTx)...">TX_SLEEP</a>;
<a name="l00390"></a>00390         <span class="keywordflow">return</span>;
<a name="l00391"></a>00391 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aeabdc0ad1691c1f0c3aad9737b3f3ba7"></a><!-- doxytag: member="ONUMacCtl::handleMessage" ref="aeabdc0ad1691c1f0c3aad9737b3f3ba7" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::handleMessage </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00084"></a>00084 {
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="comment">// Update clock from simTime</span>
<a name="l00087"></a>00087         <span class="comment">// The clock MUST be in sync</span>
<a name="l00088"></a>00088         <span class="comment">// when stop is scheduled. Stop</span>
<a name="l00089"></a>00089         <span class="comment">// is called only when entering IDLE</span>
<a name="l00090"></a>00090         <a class="code" href="classONUMacCtl.html#a6832c72c2df26d43ff0274be32f4f0b6" title="Update the clock.">clockSync</a>();
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">// Self Message</span>
<a name="l00093"></a>00093         <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
<a name="l00094"></a>00094         {
<a name="l00095"></a>00095                 EV &lt;&lt; <span class="stringliteral">&quot;Self-message &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; received\n&quot;</span>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097                 <span class="keywordflow">if</span> (msg == <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>){
<a name="l00098"></a>00098                         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> == <a class="code" href="OLTMacCtl_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>) {std::cout&lt;&lt;*msg&lt;&lt;endl; <span class="keyword">delete</span> msg; error(<span class="stringliteral">&quot;?&quot;</span>); }
<a name="l00099"></a>00099                         <a class="code" href="classONUMacCtl.html#ad67286c75033f0c90f5ba258d5acb8b9" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
<a name="l00100"></a>00100                 }
<a name="l00101"></a>00101                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg == <a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>)
<a name="l00102"></a>00102                         <a class="code" href="classONUMacCtl.html#aa245610a1fcf7a66e46f7d9d62cd5cdb">handleStopTxPeriod</a>();
<a name="l00103"></a>00103                 <span class="keywordflow">else</span>
<a name="l00104"></a>00104                         error(<span class="stringliteral">&quot;Unknown self message received!&quot;</span>);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                 <span class="keywordflow">return</span>;
<a name="l00108"></a>00108         }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 
<a name="l00112"></a>00112         <span class="comment">// Network Message</span>
<a name="l00113"></a>00113         cGate *ingate = msg-&gt;getArrivalGate();
<a name="l00114"></a>00114         EV &lt;&lt; <span class="stringliteral">&quot;Frame &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived on port &quot;</span> &lt;&lt; ingate-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;...\n&quot;</span>;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;lowerLayerIn&quot;</span>)-&gt;getId()){
<a name="l00117"></a>00117                 <a class="code" href="classONUMacCtl.html#a26a9359fab07d7d925d61cebf0c97717">processFrameFromMAC</a>(msg);
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ingate-&gt;getId() ==  gate( <span class="stringliteral">&quot;upperLayerIn&quot;</span>)-&gt;getId()){
<a name="l00120"></a>00120                 <a class="code" href="classONUMacCtl.html#ae8d8b158574a5613dda636fe89c32648">processFrameFromHigherLayer</a>(msg);
<a name="l00121"></a>00121         }<span class="keywordflow">else</span>{
<a name="l00122"></a>00122                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Message came FROM THE WRONG DIRRECTION???? Dropping\n&quot;</span>;
<a name="l00123"></a>00123                 <span class="keyword">delete</span> msg;
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa245610a1fcf7a66e46f7d9d62cd5cdb"></a><!-- doxytag: member="ONUMacCtl::handleStopTxPeriod" ref="aa245610a1fcf7a66e46f7d9d62cd5cdb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::handleStopTxPeriod </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00358"></a>00358                                   {
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00361"></a>00361         EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM ?? TO _OFF_\n&quot;</span>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="comment">/*</span>
<a name="l00364"></a>00364 <span class="comment">         *  Do NOT call start all the time...</span>
<a name="l00365"></a>00365 <span class="comment">         *</span>
<a name="l00366"></a>00366 <span class="comment">         *  WE TRIED... :-)</span>
<a name="l00367"></a>00367 <span class="comment">         */</span>
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.isEmpty()){
<a name="l00369"></a>00369                 <a class="code" href="classONUMacCtl.html#ac76f654e1e19537817c371c9f9a8d10f">goToSLEEP</a>();
<a name="l00370"></a>00370                 <span class="comment">// DO NOT RESCHEDULE START...</span>
<a name="l00371"></a>00371                 <span class="keywordflow">return</span>;
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="comment">// Shift the start_reg</span>
<a name="l00376"></a>00376         <a class="code" href="classONUMacCtl.html#aba20100031d2efa7c7cf3f96756ed5e1" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
<a name="l00377"></a>00377 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a63331ffcbc1f7055b2ce1676f5030988"></a><!-- doxytag: member="ONUMacCtl::initialize" ref="a63331ffcbc1f7055b2ce1676f5030988" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00035"></a>00035 {
<a name="l00036"></a>00036         <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>=0;
<a name="l00037"></a>00037         <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>=0;
<a name="l00038"></a>00038         <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>=0;
<a name="l00039"></a>00039         <a class="code" href="classONUMacCtl.html#a6521093d62dabc080cb69eb259e7bbbe">numGates</a> = 0;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00043"></a>00043         <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;startTxMsg&quot;</span>, <a class="code" href="ONUMacCtl_8h.html#ad087494cf3a9aeb3d94407d78e71461e">STARTTXMSG</a>);
<a name="l00044"></a>00044         <a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;stopTxMsg&quot;</span>, <a class="code" href="ONUMacCtl_8h.html#a802a25fb2e007ec326e21f3ac6b0600a">STOPTXMSG</a>);
<a name="l00045"></a>00045         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00046"></a>00046         <a class="code" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61" title="Tx Rate TODO: make it a parameter.">txrate</a>=GIGABIT_ETHERNET_TXRATE;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049         <span class="comment">// Link to MAC layer</span>
<a name="l00050"></a>00050         <a class="code" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08" title="Pointer to the mac layer for some control and use of MAC address.">emac</a> = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classEPON__mac.html" title="EPON_mac class is actually the EtherMAC2 class modified.">EPON_mac</a> *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtl.html#a3e387bb4cfe4af3bdb2cc8b37d9c4b55">getNeighbourOnGate</a>(<span class="stringliteral">&quot;lowerLayerOut&quot;</span>));
<a name="l00051"></a>00051         <span class="keywordflow">if</span> (!<a class="code" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08" title="Pointer to the mac layer for some control and use of MAC address.">emac</a>)
<a name="l00052"></a>00052                 error(<span class="stringliteral">&quot;No MAC layer found connected under ONU MAC Control Layer&quot;</span>);
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 
<a name="l00055"></a>00055         <span class="comment">// Init Stats</span>
<a name="l00056"></a>00056         <a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>=0;
<a name="l00057"></a>00057         <a class="code" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a>=0;
<a name="l00058"></a>00058         <a class="code" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">numFramesFromHLDropped</a>=0;
<a name="l00059"></a>00059         <a class="code" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">fragmentedTime</a>=0;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061     WATCH(<a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>);
<a name="l00062"></a>00062     WATCH(<a class="code" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a>);
<a name="l00063"></a>00063     WATCH(<a class="code" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">numFramesFromHLDropped</a>);
<a name="l00064"></a>00064     WATCH(<a class="code" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">fragmentedTime</a>);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     WATCH(<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>);
<a name="l00067"></a>00067     WATCH(<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>);
<a name="l00068"></a>00068     WATCH(<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>);
<a name="l00069"></a>00069     WATCH(<a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a>);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="comment">// MPCP</span>
<a name="l00073"></a>00073     <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a4be77082fa28c951f57e696c5616f3e9" title="Pre-MPCP state - Only during initialization.">TX_INIT</a>;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="comment">// Initialize the Q mgmt module</span>
<a name="l00076"></a>00076     <a class="code" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">queue_mod</a> = <span class="keyword">dynamic_cast&lt;</span>IPassiveQueue *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtl.html#a3e387bb4cfe4af3bdb2cc8b37d9c4b55">getNeighbourOnGate</a>(<span class="stringliteral">&quot;upperLayerOut&quot;</span>));
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (!<a class="code" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">queue_mod</a>)
<a name="l00078"></a>00078         error(<span class="stringliteral">&quot;ONUMacCtl: An IEponQueueMgmt is needed above mac control&quot;</span>);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae8d8b158574a5613dda636fe89c32648"></a><!-- doxytag: member="ONUMacCtl::processFrameFromHigherLayer" ref="ae8d8b158574a5613dda636fe89c32648" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::processFrameFromHigherLayer </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00128"></a>00128                                                         {
<a name="l00129"></a>00129         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Outgoing message, forwarding...\n&quot;</span>;
<a name="l00130"></a>00130         <a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>++;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         <span class="comment">// Pre-Configuration ...</span>
<a name="l00133"></a>00133         EV &lt;&lt; <span class="stringliteral">&quot;\tPacket &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived from higher layers, sending\n&quot;</span>;
<a name="l00134"></a>00134         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> == 0 ){
<a name="l00135"></a>00135                 EV&lt;&lt;<span class="stringliteral">&quot;Frame arrived in pre-conf stage &quot;</span>&lt;&lt;endl;
<a name="l00136"></a>00136                 send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
<a name="l00137"></a>00137                 <span class="keywordflow">return</span>;
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="comment">// ENQUEUE</span>
<a name="l00142"></a>00142         <a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.insert(msg);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         EV &lt;&lt; <span class="stringliteral">&quot;Wake UP message received...&quot;</span> &lt;&lt; endl;
<a name="l00145"></a>00145         <span class="comment">// Re-schedule tx period</span>
<a name="l00146"></a>00146         <span class="comment">// Check if we are idle, if yes start transmission</span>
<a name="l00147"></a>00147         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> == <a class="code" href="OLTMacCtl_8h.html#a8466586b863fc4b1722eda703698d847">TX_IDLE</a>){
<a name="l00148"></a>00148                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: CHANGING STATE FROM _IDLE_ TO _ON_\n&quot;</span>;
<a name="l00149"></a>00149                 <span class="comment">// Cancel Previous DeadLine</span>
<a name="l00150"></a>00150                 cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00151"></a>00151                 <a class="code" href="classONUMacCtl.html#ad67286c75033f0c90f5ba258d5acb8b9" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         <span class="comment">// Check if we are asleep</span>
<a name="l00154"></a>00154         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> == <a class="code" href="ONUMacCtl_8h.html#aa22f344687606a775a3466beffd86e77" title="It may or may not be our turn BUT ALL Qs ARE EMPTY (no need to schedule startTx)...">TX_SLEEP</a>){
<a name="l00155"></a>00155                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: CHANGING STATE FROM _TX_SLEEP_ TO _??_\n&quot;</span>;
<a name="l00156"></a>00156                 <span class="comment">// IF start_reg is in the future just reschedule startTX</span>
<a name="l00157"></a>00157                 <span class="comment">// ELSE shift the clock the lost slots...</span>
<a name="l00158"></a>00158                 <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> &lt; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>){
<a name="l00159"></a>00159                         cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00160"></a>00160                         <a class="code" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a>();
<a name="l00161"></a>00161                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> &gt;= <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> &lt; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> + <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>){
<a name="l00162"></a>00162                         cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00163"></a>00163                         <a class="code" href="classONUMacCtl.html#ad67286c75033f0c90f5ba258d5acb8b9" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
<a name="l00164"></a>00164                 }<span class="keywordflow">else</span> {
<a name="l00165"></a>00165                         <span class="comment">// Super Slot ...</span>
<a name="l00166"></a>00166                         uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a>/16*<a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a>;
<a name="l00167"></a>00167                         uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> - <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>)/slotTime16ns);
<a name="l00168"></a>00168                         <a class="code" href="classONUMacCtl.html#a8a9803013bbe23685f2784a7adf97636" title="This method handles the start register when the module wakes up from SLEEP state...">shiftStartXSlots</a>(lostSlots);
<a name="l00169"></a>00169                 }
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a26a9359fab07d7d925d61cebf0c97717"></a><!-- doxytag: member="ONUMacCtl::processFrameFromMAC" ref="a26a9359fab07d7d925d61cebf0c97717" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::processFrameFromMAC </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00176"></a>00176                                                 {
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Incoming message from PON\n&quot;</span>;
<a name="l00180"></a>00180         EthernetIIFrame * frame = <span class="keyword">dynamic_cast&lt;</span>EthernetIIFrame *<span class="keyword">&gt;</span>(msg);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (frame &amp;&amp; frame-&gt;getEtherType() == <a class="code" href="MPCP__codes_8h.html#a01d93522186165aff8e9d9907b04aec3">MPCP_TYPE</a>){
<a name="l00184"></a>00184 
<a name="l00185"></a>00185                 <span class="comment">// Check that the frame is for us...</span>
<a name="l00186"></a>00186                 <span class="keywordflow">if</span> (frame-&gt;getDest() != <a class="code" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08" title="Pointer to the mac layer for some control and use of MAC address.">emac</a>-&gt;getMACAddress() &amp;&amp; !frame-&gt;getDest().isBroadcast()){
<a name="l00187"></a>00187                         EV &lt;&lt; <span class="stringliteral">&quot;MPCP not for us... dropping\n&quot;</span>;
<a name="l00188"></a>00188                         <span class="keyword">delete</span> frame;
<a name="l00189"></a>00189                         <span class="keywordflow">return</span>;
<a name="l00190"></a>00190                 }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192                 <a class="code" href="classONUMacCtl.html#a1bda479d4f9746f6abb34328793b24ac">processMPCP</a>(frame );
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         send(msg,<span class="stringliteral">&quot;upperLayerOut&quot;</span>);
<a name="l00197"></a>00197         <a class="code" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">numFramesFromLL</a>++;
<a name="l00198"></a>00198 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1bda479d4f9746f6abb34328793b24ac"></a><!-- doxytag: member="ONUMacCtl::processMPCP" ref="a1bda479d4f9746f6abb34328793b24ac" args="(EthernetIIFrame *frame)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::processMPCP </td>
          <td>(</td>
          <td class="paramtype">EthernetIIFrame *&nbsp;</td>
          <td class="paramname"> <em>frame</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><p>NOTE: Announced time IS NOT ALWAYS ON THE FUTURE IF we want the announced times to be on the future then the DBA algorithms MUST CONSIDER RTT. For simplicity we do accept to loose some slots...</p>
</p>

<p><div class="fragment"><pre class="fragment"><a name="l00201"></a>00201                                                   {
<a name="l00202"></a>00202         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: MPCP Frame processing\n&quot;</span>;
<a name="l00203"></a>00203         <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = check_and_cast&lt;<a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *&gt;(frame);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">// DONT... DONT EVEN THINK OF IT</span>
<a name="l00207"></a>00207 <span class="comment">//      EV &lt;&lt; &quot;ONUMacCtl: Updating our clock from: &quot;&lt;&lt;clock_reg&lt;&lt;&quot; to &quot;;</span>
<a name="l00208"></a>00208 <span class="comment">//      clock_reg=mpcp-&gt;getTs();</span>
<a name="l00209"></a>00209 <span class="comment">//      EV &lt;&lt; clock_reg &lt;&lt; endl;</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="keywordflow">switch</span> (mpcp-&gt;<a class="code" href="classMPCP.html#a68374d0a62fbdd1c40f264f1a9a9230b">getOpcode</a>())
<a name="l00212"></a>00212         {
<a name="l00213"></a>00213 
<a name="l00214"></a>00214                 <span class="keywordflow">case</span> <a class="code" href="MPCP__codes_8h.html#a190716814784e1e13cfd09ef6e773f5d">MPCP_GATE</a>:
<a name="l00215"></a>00215                 {
<a name="l00216"></a>00216                         <a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> * gate = check_and_cast&lt;<a class="code" href="classMPCPGate.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCPGate</a> *&gt;(frame);
<a name="l00217"></a>00217                         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Type is MPCP_GATE\n&quot;</span>;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219                         <span class="keywordflow">if</span> (gate-&gt;<a class="code" href="classMPCPGate.html#aa568e79e9c26b388d9e291ccd76db8c5">getListLen</a>() == 0) {
<a name="l00220"></a>00220                                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: !!! NO ALLOCATION FOR US :-( (bitches...)&quot;</span>;
<a name="l00221"></a>00221                                 <span class="keywordflow">break</span>;
<a name="l00222"></a>00222                         }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 
<a name="l00225"></a>00225                         <span class="comment">// Update with 1st alloc</span>
<a name="l00226"></a>00226                         <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a188d0342a2fb1c02190fc079aa2b20d9">getStartTime</a>(0);
<a name="l00227"></a>00227                         <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a3b82c4a4e1246e2170e49451690d9efe">getDuration</a>(0);
<a name="l00228"></a>00228                         <a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a> = gate-&gt;<a class="code" href="classMPCPGate.html#a568ad27f81f61ff5bb0eb5d1b6aad9b9">getSlotTime</a>();
<a name="l00229"></a>00229                         <a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a> = gate-&gt;<a class="code" href="classMPCPGate.html#ab25cbd133a2cf312e62abe9d80aa5d8d">getSlotsNum</a>();
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00238"></a>00238                         <span class="keywordflow">if</span> ( <a class="code" href="classONUMacCtl.html#a6521093d62dabc080cb69eb259e7bbbe">numGates</a> == 0){
<a name="l00239"></a>00239                                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: MPCP_GATE arrived, IT IS INITIAL - MAC: &quot;</span>&lt;&lt;frame-&gt;getDest()&lt;&lt;endl;
<a name="l00240"></a>00240                                 <span class="comment">// Cancel ALL an scheduled TX</span>
<a name="l00241"></a>00241                                 cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00242"></a>00242                                 cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00243"></a>00243                                 <a class="code" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a>();
<a name="l00244"></a>00244                         }<span class="keywordflow">else</span>{
<a name="l00245"></a>00245 
<a name="l00246"></a>00246                                 <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&gt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> + <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>){
<a name="l00247"></a>00247                                         <span class="comment">// Time assigned is in past</span>
<a name="l00248"></a>00248                                         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: MPCP_GATE arrived, calculating lost slots&quot;</span>&lt;&lt;endl;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250                                         <span class="comment">// Super Slot ...</span>
<a name="l00251"></a>00251                                         uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a>/16*<a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a>;
<a name="l00252"></a>00252                                         uint32_t lostSlots = ceil((<span class="keywordtype">double</span>)(<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> - <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>)/slotTime16ns);
<a name="l00253"></a>00253                                         <a class="code" href="classONUMacCtl.html#a8a9803013bbe23685f2784a7adf97636" title="This method handles the start register when the module wakes up from SLEEP state...">shiftStartXSlots</a>(lostSlots);
<a name="l00254"></a>00254                                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&gt;=<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> &amp;&amp; <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> &lt; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> + <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>){
<a name="l00255"></a>00255                                         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: MPCP_GATE arrived, it is our time&quot;</span>&lt;&lt;endl;
<a name="l00256"></a>00256                                         <span class="comment">// Now is our time</span>
<a name="l00257"></a>00257                                         <a class="code" href="classONUMacCtl.html#a3a9f9c2e73158215f5863f7c2c2d59a6">scheduleStopTxPeriod</a>();
<a name="l00258"></a>00258                                         <a class="code" href="classONUMacCtl.html#ad67286c75033f0c90f5ba258d5acb8b9" title="Directly called for start Messages and called if a frame arrives in IDLE.">startTxOnPON</a>();
<a name="l00259"></a>00259                                 }<span class="keywordflow">else</span>{
<a name="l00260"></a>00260                                         <span class="comment">// Time assigned is in future</span>
<a name="l00261"></a>00261                                         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: MPCP_GATE arrived, no lost slots&quot;</span>&lt;&lt;endl;
<a name="l00262"></a>00262                                         <a class="code" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a>();
<a name="l00263"></a>00263                                 }
<a name="l00264"></a>00264                         }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00267"></a>00267                         <a class="code" href="classONUMacCtl.html#a6521093d62dabc080cb69eb259e7bbbe">numGates</a>++;
<a name="l00268"></a>00268                         <span class="keywordflow">break</span>;
<a name="l00269"></a>00269                 }
<a name="l00270"></a>00270                 <span class="keywordflow">default</span>:
<a name="l00271"></a>00271                         <span class="keywordflow">break</span>;
<a name="l00272"></a>00272         };
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aefa31de5b18a6f6e5b7784534465303f"></a><!-- doxytag: member="ONUMacCtl::scheduleStartTxPeriod" ref="aefa31de5b18a6f6e5b7784534465303f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::scheduleStartTxPeriod </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00277"></a>00277                                      {
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM ?? TO _OFF_\n&quot;</span>;
<a name="l00280"></a>00280         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="comment">/*</span>
<a name="l00284"></a>00284 <span class="comment">         *  start_reg shifted clock_reg did not</span>
<a name="l00285"></a>00285 <span class="comment">         *  HANDLE AND RETURN.</span>
<a name="l00286"></a>00286 <span class="comment">         *</span>
<a name="l00287"></a>00287 <span class="comment">         *  NOTE:       This should occur only on shifted registers.</span>
<a name="l00288"></a>00288 <span class="comment">         *              MPCP could have the same result but we are fixing</span>
<a name="l00289"></a>00289 <span class="comment">         *              it by shifting the clock on receive.</span>
<a name="l00290"></a>00290 <span class="comment">         */</span>
<a name="l00291"></a>00291         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>!=0 &amp;&amp; (uint64_t)<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>&lt;<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>) {
<a name="l00292"></a>00292                 EV&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl: Start_reg shifted clock_reg did not&quot;</span>&lt;&lt;endl;
<a name="l00293"></a>00293                 <a class="code" href="classONUMacCtl.html#a81c8e32f236ce95bf4b6831f84ca04e1">dumpReg</a>();
<a name="l00294"></a>00294                 <span class="comment">//error(&quot;start_reg+len_reg&lt;clock_reg &quot;);</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                 simtime_t nextTx;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299                 nextTx.setRaw(simTime().raw() + <span class="comment">// NOW</span>
<a name="l00300"></a>00300                                 <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a> - <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> + <span class="comment">// Remaining (not shifted clock)</span>
<a name="l00301"></a>00301                                                 <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>
<a name="l00302"></a>00302                                         ));
<a name="l00303"></a>00303                 EV&lt;&lt;<span class="stringliteral">&quot;....&quot;</span>&lt;&lt;(<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a> - <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> +<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>)&lt;&lt;endl;
<a name="l00304"></a>00304                 EV&lt;&lt;<span class="stringliteral">&quot;scheduleStartTxPeriod: &quot;</span>&lt;&lt;nextTx&lt;&lt;endl;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306                 cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00307"></a>00307                 scheduleAt(nextTx, <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00308"></a>00308                 <span class="keywordflow">return</span>;
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         simtime_t nextTx;
<a name="l00312"></a>00312         <span class="comment">// Start the next moment...</span>
<a name="l00313"></a>00313         nextTx.setRaw(simTime().raw());
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">// If start time is ahead sim time Start now</span>
<a name="l00316"></a>00316         <span class="comment">// clock_reg == MPCPTools::simTimeToNS16()....</span>
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&gt;=<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>){
<a name="l00318"></a>00318                 nextTx.setRaw(simTime().raw()+                                                          <span class="comment">//Now (NOTE: not the clock_reg)</span>
<a name="l00319"></a>00319                                           <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>-<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>) <span class="comment">//Remaining time to Start</span>
<a name="l00320"></a>00320                                          );
<a name="l00321"></a>00321                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Start scheduled. Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&lt;&lt;<span class="stringliteral">&quot; Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;&lt;endl;
<a name="l00322"></a>00322         }<span class="keywordflow">else</span>{
<a name="l00323"></a>00323                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Starting NOW. Clock: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&lt;&lt;<span class="stringliteral">&quot; Start: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;&lt;endl;
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00328"></a>00328         scheduleAt(nextTx, <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00329"></a>00329 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3a9f9c2e73158215f5863f7c2c2d59a6"></a><!-- doxytag: member="ONUMacCtl::scheduleStopTxPeriod" ref="a3a9f9c2e73158215f5863f7c2c2d59a6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::scheduleStopTxPeriod </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><div class="fragment"><pre class="fragment"><a name="l00339"></a>00339                                     {
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">// You cannot calculate next time from registers...</span>
<a name="l00342"></a>00342         <span class="comment">// Simulation time may be different (regs are shifted)</span>
<a name="l00343"></a>00343         <span class="comment">// So calculate the remaining time...</span>
<a name="l00344"></a>00344         simtime_t stopTX;
<a name="l00345"></a>00345         stopTX.setRaw( simTime().raw() +                                                 <span class="comment">// Now</span>
<a name="l00346"></a>00346                         <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> +<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> - <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>) <span class="comment">// Remaining</span>
<a name="l00347"></a>00347         );
<a name="l00348"></a>00348         <a class="code" href="classONUMacCtl.html#a81c8e32f236ce95bf4b6831f84ca04e1">dumpReg</a>();
<a name="l00349"></a>00349         EV &lt;&lt; <span class="stringliteral">&quot;Scheduled after (ns16): &quot;</span> &lt;&lt; (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> +<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> - <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>) &lt;&lt;endl;
<a name="l00350"></a>00350         EV &lt;&lt; <span class="stringliteral">&quot;Scheduled after  (raw): &quot;</span> &lt;&lt; <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>(<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> +<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> - <a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>) &lt;&lt;endl;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">// Just in case..</span>
<a name="l00353"></a>00353         cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00354"></a>00354         scheduleAt(stopTX, <a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aba20100031d2efa7c7cf3f96756ed5e1"></a><!-- doxytag: member="ONUMacCtl::shiftStart1Slot" ref="aba20100031d2efa7c7cf3f96756ed5e1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::shiftStart1Slot </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This method shifts the start register for one SuperSlot. </p>
<p>SuperSlot is defined as the summation of all the slot lengths. </p>

<p><div class="fragment"><pre class="fragment"><a name="l00631"></a>00631                                {
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         uint64_t slotTime16ns = ((double)<a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a>/16)*<a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         EV &lt;&lt; <span class="stringliteral">&quot;Increasing Start Reg.: old=&quot;</span> &lt;&lt; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>
<a name="l00636"></a>00636                 &lt;&lt;<span class="stringliteral">&quot; + &quot;</span> &lt;&lt; slotTime16ns;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         <span class="comment">// NOTE: start_reg may OVERFLOW TOOooo...  tsouf</span>
<a name="l00639"></a>00639         <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> = ((uint64_t)<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+slotTime16ns)%<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a>;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 
<a name="l00642"></a>00642         EV&lt;&lt;<span class="stringliteral">&quot; = &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;&lt;<span class="stringliteral">&quot; Clock Now: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&lt;&lt;endl;
<a name="l00643"></a>00643         EV&lt;&lt;<span class="stringliteral">&quot;SlotLength: &quot;</span>&lt;&lt;slotTime16ns&lt;&lt;endl&lt;&lt;endl;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="comment">// Reschedule next TX</span>
<a name="l00647"></a>00647         <a class="code" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a>();
<a name="l00648"></a>00648 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8a9803013bbe23685f2784a7adf97636"></a><!-- doxytag: member="ONUMacCtl::shiftStartXSlots" ref="a8a9803013bbe23685f2784a7adf97636" args="(uint32_t X)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::shiftStartXSlots </td>
          <td>(</td>
          <td class="paramtype">uint32_t&nbsp;</td>
          <td class="paramname"> <em>X</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This method handles the start register when the module wakes up from SLEEP state and it has lost many SuperSlots. </p>

<p><div class="fragment"><pre class="fragment"><a name="l00650"></a>00650                                           {
<a name="l00651"></a>00651         uint64_t slotTime16ns = (double)<a class="code" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">slotLength</a>/16*<a class="code" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">slotNumber</a>;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         EV &lt;&lt; <span class="stringliteral">&quot;Increasing Start: old=&quot;</span> &lt;&lt; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>
<a name="l00654"></a>00654                 &lt;&lt;<span class="stringliteral">&quot; + &quot;</span> &lt;&lt; X*slotTime16ns;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> = ((uint64_t)<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+X*slotTime16ns)%<a class="code" href="MPCPTools_8h.html#a7a11b1805a8a4c73e5b844a12b98a531">MPCP_CLOCK_MAX</a>;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a>00659         EV&lt;&lt;<span class="stringliteral">&quot; = &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>&lt;&lt;endl;
<a name="l00660"></a>00660         EV&lt;&lt;<span class="stringliteral">&quot;Lost Slots: &quot;</span>&lt;&lt;X&lt;&lt;<span class="stringliteral">&quot; SlotLength: &quot;</span>&lt;&lt;slotTime16ns&lt;&lt;endl&lt;&lt;endl;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="comment">// Reschedule next TX</span>
<a name="l00663"></a>00663         <a class="code" href="classONUMacCtl.html#aefa31de5b18a6f6e5b7784534465303f">scheduleStartTxPeriod</a>();
<a name="l00664"></a>00664 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad67286c75033f0c90f5ba258d5acb8b9"></a><!-- doxytag: member="ONUMacCtl::startTxOnPON" ref="ad67286c75033f0c90f5ba258d5acb8b9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ONUMacCtl::startTxOnPON </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Directly called for start Messages and called if a frame arrives in IDLE. </p>

<p><p>Check to be sure...</p>
<p>Sometimes because we add 0.001 to startTx schedule, results to clock_reg = start+len +1</p>
<p>So, shift a slot.</p>
<p>Check that the MAC layer is not in TX mode</p>
<p>This happens on the case of rapid <a class="el" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> messages. What we do is to wait for the minimum frame length bit time which is : ((double)64*8)/txrate.</p>
<p>NOTE: that +1 is needed to the nextTx because the 2 messages (EndTransmission and startTx) are scheduled at the same EXACT time. Thus simulator will parse first the latest (LIFO) which is the startTx and we will have to wait 1 round more.</p>
<p>Request next packet and set to IDLE state</p>
<p>Check That he allocated time is more than the frame... If it is not discart the frame, it is going to block all the rest...</p>
</p>

<p><div class="fragment"><pre class="fragment"><a name="l00397"></a>00397                             {
<a name="l00406"></a>00406         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>&gt;<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> &amp;&amp; <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>!=0) {
<a name="l00407"></a>00407                 <a class="code" href="classONUMacCtl.html#aba20100031d2efa7c7cf3f96756ed5e1" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
<a name="l00408"></a>00408                 std::cout&lt;&lt;<span class="stringliteral">&quot;ONUMacCtl: SHIT: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
<a name="l00409"></a>00409                 <span class="keywordflow">return</span>;
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411 
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08" title="Pointer to the mac layer for some control and use of MAC address.">emac</a>-&gt;getQueueLength()&gt;0){
<a name="l00427"></a>00427                 EV&lt;&lt;<span class="stringliteral">&quot;DELAYing MAC busy: &quot;</span>&lt;&lt;simTime()&lt;&lt;endl;
<a name="l00428"></a>00428                 cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00429"></a>00429                 simtime_t delayTx = ((double)64*8)/<a class="code" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61" title="Tx Rate TODO: make it a parameter.">txrate</a>;
<a name="l00430"></a>00430                 simtime_t timerem;
<a name="l00431"></a>00431                 timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>-<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> ));
<a name="l00432"></a>00432                 <span class="keywordflow">if</span> (timerem&gt;delayTx){
<a name="l00433"></a>00433                         scheduleAt(delayTx+simTime(), <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435                 }<span class="keywordflow">else</span>{
<a name="l00436"></a>00436                         <a class="code" href="classONUMacCtl.html#aba20100031d2efa7c7cf3f96756ed5e1" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
<a name="l00437"></a>00437                 }
<a name="l00438"></a>00438                 <span class="keywordflow">return</span>;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.isEmpty()){
<a name="l00445"></a>00445                 <a class="code" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">queue_mod</a>-&gt;requestPacket();
<a name="l00446"></a>00446 
<a name="l00447"></a>00447                 <span class="comment">// MPCP period</span>
<a name="l00448"></a>00448                 <span class="keywordflow">if</span> (<a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a> == 0){
<a name="l00449"></a>00449                         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00450"></a>00450                         EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
<a name="l00451"></a>00451                         <span class="keywordflow">return</span>;
<a name="l00452"></a>00452                 }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454                 EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM _ON_ TO _IDLE_ (no message in tmp queue)\n&quot;</span>;
<a name="l00455"></a>00455                 <a class="code" href="classONUMacCtl.html#a93a1b30420857d24af3b3f15aa5678d1">goToIDLE</a>();
<a name="l00456"></a>00456 
<a name="l00457"></a>00457                 <span class="keywordflow">return</span>;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM ?? TO _ON_\n&quot;</span>;
<a name="l00462"></a>00462         <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a4736ad0b388fe0fd16bf2620ec35e03d" title="Laser is ON and transmitting.">TX_ON</a>;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464         uint32_t nextMsgSize =  ((cPacket *)<a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.front())-&gt;getByteLength();
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         <span class="comment">// Calculate TX and remaining time</span>
<a name="l00468"></a>00468         <span class="comment">// NOTE: Change here for more bandwidth</span>
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (nextMsgSize&lt;64) nextMsgSize=64;
<a name="l00470"></a>00470         uint32_t bytes=nextMsgSize+PREAMBLE_BYTES+SFD_BYTES;
<a name="l00471"></a>00471         bytes+=INTERFRAME_GAP_BITS/8;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         <span class="comment">// TODO: Add laser on/off delay</span>
<a name="l00474"></a>00474         simtime_t timereq = ((double)bytes*8)/<a class="code" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61" title="Tx Rate TODO: make it a parameter.">txrate</a>;
<a name="l00475"></a>00475         EV &lt;&lt; <span class="stringliteral">&quot;Total Bytes: &quot;</span>&lt;&lt;bytes&lt;&lt;<span class="stringliteral">&quot; Total bits: &quot;</span>&lt;&lt;bytes*8&lt;&lt;<span class="stringliteral">&quot; TX RATE: &quot;</span>&lt;&lt;<a class="code" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61" title="Tx Rate TODO: make it a parameter.">txrate</a>&lt;&lt;endl;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         simtime_t timerem;
<a name="l00478"></a>00478         timerem.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">start_reg</a>+<a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a>-<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a> ));
<a name="l00479"></a>00479 
<a name="l00480"></a>00480         EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (sim): &quot;</span>&lt;&lt;timereq&lt;&lt;endl;
<a name="l00481"></a>00481         EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (sim): &quot;</span>&lt;&lt;timerem&lt;&lt;endl;
<a name="l00482"></a>00482         EV &lt;&lt; <span class="stringliteral">&quot;*** It will take (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timereq.raw())&lt;&lt;endl;
<a name="l00483"></a>00483         EV &lt;&lt; <span class="stringliteral">&quot;*** We Still have (ns16): &quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(timerem.raw())&lt;&lt;endl;
<a name="l00484"></a>00484         <a class="code" href="classONUMacCtl.html#a81c8e32f236ce95bf4b6831f84ca04e1">dumpReg</a>();
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         <span class="comment">// If we dont have time break</span>
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (timerem&lt;timereq){
<a name="l00493"></a>00493                 simtime_t totaltime;
<a name="l00494"></a>00494                 totaltime.setRaw( <a class="code" href="classMPCPTools.html#a1013f56301a3f993a5d30b238ac901cc">MPCPTools::ns16ToSimTime</a>( <a class="code" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">len_reg</a> ));
<a name="l00495"></a>00495                 <span class="keywordflow">if</span> (totaltime&lt;timereq){
<a name="l00496"></a>00496                         EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Frame is too big to FIT THE WHOLE TIME SLOT!\n&quot;</span>;
<a name="l00497"></a>00497                         <span class="comment">// Discard and continue (the code)...</span>
<a name="l00498"></a>00498                         <span class="comment">// TODO: Maybe add a counter!</span>
<a name="l00499"></a>00499                         cancelAndDelete(dynamic_cast&lt;cMessage *&gt;(<a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.pop()));
<a name="l00500"></a>00500                 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502                 <span class="comment">// Log fragmented time</span>
<a name="l00503"></a>00503                 EV &lt;&lt; <span class="stringliteral">&quot;ONUMacCtl: Fragmented TimeSlot... Frame is too big\n&quot;</span>;
<a name="l00504"></a>00504                 EV &lt;&lt; <span class="stringliteral">&quot;\n==ONUMacCtl: CHANGING STATE FROM _ON_ TO _OFF_\n&quot;</span>;
<a name="l00505"></a>00505                 <a class="code" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">transmitState</a> = <a class="code" href="ONUMacCtl_8h.html#a36e3e2ef609ae8575b61fe2c6a9ae35b" title="Laser is OFF - Not our timeslot.">TX_OFF</a>;
<a name="l00506"></a>00506                 <a class="code" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">fragmentedTime</a> += timerem;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508                 <span class="comment">// Shift the start_reg</span>
<a name="l00509"></a>00509                 <a class="code" href="classONUMacCtl.html#aba20100031d2efa7c7cf3f96756ed5e1" title="This method shifts the start register for one SuperSlot.">shiftStart1Slot</a>();
<a name="l00510"></a>00510                 <span class="comment">// cancel the stop message</span>
<a name="l00511"></a>00511                 <span class="comment">// (else we lose a time slot)</span>
<a name="l00512"></a>00512                 cancelEvent(<a class="code" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">stopTxMsg</a>);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514                 <span class="keywordflow">return</span>;
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517         cPacket * msg = <span class="keyword">dynamic_cast&lt;</span>cPacket *<span class="keyword">&gt;</span>(<a class="code" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">tmp_queue</a>.pop());
<a name="l00518"></a>00518         <span class="comment">// Check the user implementation of the Queues</span>
<a name="l00519"></a>00519         <span class="keywordflow">if</span> (!msg){
<a name="l00520"></a>00520                 error(  <span class="stringliteral">&quot;Shit... we should never reach here: &quot;</span>
<a name="l00521"></a>00521                                 <span class="stringliteral">&quot;UNKNOWN message... NOT A cPACKET&quot;</span>);
<a name="l00522"></a>00522                 <span class="keywordflow">return</span>;
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// Add CURRENT TIME STAMP</span>
<a name="l00526"></a>00526         <a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> * mpcp = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classMPCP.html" title="Class generated from common/EPON_messages.msg by opp_msgc.">MPCP</a> *<span class="keyword">&gt;</span>(msg);
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (mpcp){
<a name="l00528"></a>00528                 mpcp-&gt;<a class="code" href="classMPCP.html#ae7828b734088f73c3b55adf0dfc1197e">setTs</a>(<a class="code" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">clock_reg</a>);
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="comment">// We have enough time for the frame...</span>
<a name="l00532"></a>00532         <span class="comment">//Send</span>
<a name="l00533"></a>00533         send(msg, <span class="stringliteral">&quot;lowerLayerOut&quot;</span>);
<a name="l00534"></a>00534         <a class="code" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">numFramesFromHL</a>++;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 
<a name="l00537"></a>00537         EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (RAW): \t&quot;</span>&lt;&lt;simTime().raw()&lt;&lt;endl;
<a name="l00538"></a>00538         EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(RAW): \t&quot;</span>&lt;&lt;simTime().raw() + timereq.raw()&lt;&lt;endl;
<a name="l00539"></a>00539         EV &lt;&lt; <span class="stringliteral">&quot;*** Current simTime (ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw())&lt;&lt;endl;
<a name="l00540"></a>00540         EV &lt;&lt; <span class="stringliteral">&quot;*** Next Message simTime(ns16): \t&quot;</span>&lt;&lt;<a class="code" href="classMPCPTools.html#acb405d0b706b3d106604fdc8f442de9d">MPCPTools::simTimeToNS16</a>(simTime().raw() + timereq.raw())&lt;&lt;endl;
<a name="l00541"></a>00541         simtime_t nextTx;
<a name="l00542"></a>00542         <span class="comment">// LOOK at the NOTE on the begging</span>
<a name="l00543"></a>00543         nextTx = simTime() + timereq;
<a name="l00544"></a>00544 <span class="comment">//      std::cout&lt;&lt;nextTx&lt;&lt;endl;</span>
<a name="l00545"></a>00545 <span class="comment">//</span>
<a name="l00546"></a>00546         nextTx+= 0.001/(double)<a class="code" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61" title="Tx Rate TODO: make it a parameter.">txrate</a>;
<a name="l00547"></a>00547         cancelEvent(<a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00548"></a>00548         scheduleAt(nextTx, <a class="code" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">startTxMsg</a>);
<a name="l00549"></a>00549 }
</pre></div></p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a5aa2760969e7f808aaf76f96b94f8732"></a><!-- doxytag: member="ONUMacCtl::clock_reg" ref="a5aa2760969e7f808aaf76f96b94f8732" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t <a class="el" href="classONUMacCtl.html#a5aa2760969e7f808aaf76f96b94f8732">ONUMacCtl::clock_reg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a46b25de817b0427f1fc9d10e95d66d08"></a><!-- doxytag: member="ONUMacCtl::emac" ref="a46b25de817b0427f1fc9d10e95d66d08" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classEPON__mac.html">EPON_mac</a>* <a class="el" href="classONUMacCtl.html#a46b25de817b0427f1fc9d10e95d66d08">ONUMacCtl::emac</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Pointer to the mac layer for some control and use of MAC address. </p>

</div>
</div>
<a class="anchor" id="a3b134d2ae6381ab6763e2ff758e1c226"></a><!-- doxytag: member="ONUMacCtl::fragmentedTime" ref="a3b134d2ae6381ab6763e2ff758e1c226" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">simtime_t <a class="el" href="classONUMacCtl.html#a3b134d2ae6381ab6763e2ff758e1c226">ONUMacCtl::fragmentedTime</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aca475a5a598f00582ddaf63dc13705d3"></a><!-- doxytag: member="ONUMacCtl::len_reg" ref="aca475a5a598f00582ddaf63dc13705d3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t <a class="el" href="classONUMacCtl.html#aca475a5a598f00582ddaf63dc13705d3">ONUMacCtl::len_reg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a7c164ddb8915f83b10c3315ded65baed"></a><!-- doxytag: member="ONUMacCtl::numFramesFromHL" ref="a7c164ddb8915f83b10c3315ded65baed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#a7c164ddb8915f83b10c3315ded65baed">ONUMacCtl::numFramesFromHL</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aeb2b34623c28d34ef3a79e5a2c5e87cc"></a><!-- doxytag: member="ONUMacCtl::numFramesFromHLDropped" ref="aeb2b34623c28d34ef3a79e5a2c5e87cc" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#aeb2b34623c28d34ef3a79e5a2c5e87cc">ONUMacCtl::numFramesFromHLDropped</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a99a5e501497013b9d527761518294301"></a><!-- doxytag: member="ONUMacCtl::numFramesFromLL" ref="a99a5e501497013b9d527761518294301" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#a99a5e501497013b9d527761518294301">ONUMacCtl::numFramesFromLL</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a6521093d62dabc080cb69eb259e7bbbe"></a><!-- doxytag: member="ONUMacCtl::numGates" ref="a6521093d62dabc080cb69eb259e7bbbe" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#a6521093d62dabc080cb69eb259e7bbbe">ONUMacCtl::numGates</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a60d507991fc7601084409cc235254b3c"></a><!-- doxytag: member="ONUMacCtl::queue_mod" ref="a60d507991fc7601084409cc235254b3c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">IPassiveQueue* <a class="el" href="classONUMacCtl.html#a60d507991fc7601084409cc235254b3c">ONUMacCtl::queue_mod</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aec7348c33d5d4638d4456a6171604182"></a><!-- doxytag: member="ONUMacCtl::RTT" ref="aec7348c33d5d4638d4456a6171604182" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#aec7348c33d5d4638d4456a6171604182">ONUMacCtl::RTT</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a7ea38ec2a1dd157cca572a59fa6c7ad2"></a><!-- doxytag: member="ONUMacCtl::slotLength" ref="a7ea38ec2a1dd157cca572a59fa6c7ad2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t <a class="el" href="classONUMacCtl.html#a7ea38ec2a1dd157cca572a59fa6c7ad2">ONUMacCtl::slotLength</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="adb0f0f7a3b188dcd9fc325c7c6eab653"></a><!-- doxytag: member="ONUMacCtl::slotNumber" ref="adb0f0f7a3b188dcd9fc325c7c6eab653" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t <a class="el" href="classONUMacCtl.html#adb0f0f7a3b188dcd9fc325c7c6eab653">ONUMacCtl::slotNumber</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="abbc8774be79e0cbea3ebffc9d4c9db44"></a><!-- doxytag: member="ONUMacCtl::start_reg" ref="abbc8774be79e0cbea3ebffc9d4c9db44" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t <a class="el" href="classONUMacCtl.html#abbc8774be79e0cbea3ebffc9d4c9db44">ONUMacCtl::start_reg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a3ea7c1c0faab16558b90548e1f0b8434"></a><!-- doxytag: member="ONUMacCtl::startTxMsg" ref="a3ea7c1c0faab16558b90548e1f0b8434" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage* <a class="el" href="classONUMacCtl.html#a3ea7c1c0faab16558b90548e1f0b8434">ONUMacCtl::startTxMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="af3e6306a91e1e8e7292759eda2b7b125"></a><!-- doxytag: member="ONUMacCtl::stopTxMsg" ref="af3e6306a91e1e8e7292759eda2b7b125" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage * <a class="el" href="classONUMacCtl.html#af3e6306a91e1e8e7292759eda2b7b125">ONUMacCtl::stopTxMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aab7a8be5d32d2da0e9eb412bafacd2d9"></a><!-- doxytag: member="ONUMacCtl::syncMsg" ref="aab7a8be5d32d2da0e9eb412bafacd2d9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage * <a class="el" href="classONUMacCtl.html#aab7a8be5d32d2da0e9eb412bafacd2d9">ONUMacCtl::syncMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aa9db40580c51071e1007673222e71652"></a><!-- doxytag: member="ONUMacCtl::tmp_queue" ref="aa9db40580c51071e1007673222e71652" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cQueue <a class="el" href="classONUMacCtl.html#aa9db40580c51071e1007673222e71652">ONUMacCtl::tmp_queue</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a9de74f6b93bc5724d02e42d471cf74cb"></a><!-- doxytag: member="ONUMacCtl::transmitState" ref="a9de74f6b93bc5724d02e42d471cf74cb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="classONUMacCtl.html#a9de74f6b93bc5724d02e42d471cf74cb">ONUMacCtl::transmitState</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a8ed7b330c8432443882619613ab3ee61"></a><!-- doxytag: member="ONUMacCtl::txrate" ref="a8ed7b330c8432443882619613ab3ee61" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t <a class="el" href="classONUMacCtl.html#a8ed7b330c8432443882619613ab3ee61">ONUMacCtl::txrate</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Tx Rate TODO: make it a parameter. </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="ONUMacCtl_8h.html">ONUMacCtl.h</a></li>
<li><a class="el" href="ONUMacCtl_8cc.html">ONUMacCtl.cc</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Sep 21 16:17:35 2011 for EPONImplementationforOMNet++ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
